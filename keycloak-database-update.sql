-- *********************************************************************
-- Update Database Script
-- *********************************************************************
-- Change Log: META-INF/jpa-changelog-master.xml
-- Ran at: 7/4/21, 5:03 PM
-- Against: MyLogin@jdbc:sqlserver://localhost:1444;useFmtOnly=false;useBulkCopyForBatchInsert=false;cancelQueryTimeout=-1;sslProtocol=TLS;jaasConfigurationName=SQLJDBCDriver;statementPoolingCacheSize=0;serverPreparedStatementDiscardThreshold=10;enablePrepareOnFirstPreparedStatementCall=false;fips=false;socketTimeout=0;authentication=NotSpecified;authenticationScheme=nativeAuthentication;xopenStates=false;sendTimeAsDatetime=true;trustStoreType=JKS;trustServerCertificate=false;TransparentNetworkIPResolution=true;serverNameAsACE=false;sendStringParametersAsUnicode=true;selectMethod=direct;responseBuffering=adaptive;queryTimeout=-1;packetSize=8000;multiSubnetFailover=false;loginTimeout=30;lockTimeout=-1;lastUpdateCount=true;encrypt=false;disableStatementPooling=true;databaseName=Keycloak;columnEncryptionSetting=Disabled;applicationName=Microsoft JDBC Driver for SQL Server;applicationIntent=readwrite;
-- Liquibase version: 3.8.8
-- *********************************************************************

USE Keycloak;
GO

-- Changeset META-INF/jpa-changelog-1.3.0.xml::1.3.0::bburke@redhat.com
DELETE
FROM CLIENT_SESSION_ROLE
GO

DELETE
FROM CLIENT_SESSION_PROT_MAPPER
GO

DELETE
FROM CLIENT_SESSION_NOTE
GO

DELETE
FROM CLIENT_SESSION
GO

DELETE
FROM USER_SESSION_NOTE
GO

DELETE
FROM USER_SESSION
GO

CREATE TABLE ADMIN_EVENT_ENTITY
(
    ID               varchar(36) NOT NULL,
    ADMIN_EVENT_TIME bigint,
    REALM_ID         varchar(255),
    OPERATION_TYPE   varchar(255),
    AUTH_REALM_ID    varchar(255),
    AUTH_CLIENT_ID   varchar(255),
    AUTH_USER_ID     varchar(255),
    IP_ADDRESS       varchar(255),
    RESOURCE_PATH    varchar(2550),
    REPRESENTATION   varchar(max),
    ERROR            varchar
)
GO

CREATE TABLE AUTHENTICATOR
(
    ID          varchar(36) NOT NULL,
    ALIAS       varchar(255),
    REALM_ID    varchar(36),
    PROVIDER_ID varchar(255)
)
GO

CREATE TABLE AUTHENTICATION_FLOW
(
    ID          varchar(36) NOT NULL,
    ALIAS       varchar(255),
    DESCRIPTION varchar(255),
    REALM_ID    varchar(36)
)
GO

CREATE TABLE AUTHENTICATION_EXECUTION
(
    ID                 varchar(36)                                          NOT NULL,
    ALIAS              varchar(255),
    AUTHENTICATOR      varchar(36),
    REALM_ID           varchar(36),
    FLOW_ID            varchar(36),
    REQUIREMENT        int,
    PRIORITY           int,
    USER_SETUP_ALLOWED bit
        CONSTRAINT DF_AUTHENTICATION_EXECUTION_USER_SETUP_ALLOWED DEFAULT 0 NOT NULL,
    AUTHENTICATOR_FLOW bit
        CONSTRAINT DF_AUTHENTICATION_EXECUTION_AUTHENTICATOR_FLOW DEFAULT 0 NOT NULL
)
GO

CREATE TABLE AUTHENTICATOR_CONFIG
(
    AUTHENTICATOR_ID varchar(36)  NOT NULL,
    VALUE            varchar(MAX),
    NAME             varchar(255) NOT NULL
)
GO

CREATE TABLE USER_FEDERATION_MAPPER
(
    ID                     varchar(36)  NOT NULL,
    NAME                   varchar(255) NOT NULL,
    FEDERATION_PROVIDER_ID varchar(36)  NOT NULL,
    FEDERATION_MAPPER_TYPE varchar(255) NOT NULL,
    REALM_ID               varchar(36)  NOT NULL
)
GO

CREATE TABLE USER_FEDERATION_MAPPER_CONFIG
(
    USER_FEDERATION_MAPPER_ID varchar(36)  NOT NULL,
    VALUE                     varchar(255),
    NAME                      varchar(255) NOT NULL
)
GO

ALTER TABLE REALM
    ADD ADMIN_EVENTS_ENABLED bit
        CONSTRAINT DF_REALM_ADMIN_EVENTS_ENABLED DEFAULT 0 NOT NULL
GO

ALTER TABLE REALM
    ADD ADMIN_EVENTS_DETAILS_ENABLED bit
        CONSTRAINT DF_REALM_ADMIN_EVENTS_DETAILS_ENABLED DEFAULT 0 NOT NULL
GO

ALTER TABLE REALM
    ADD EDIT_USERNAME_ALLOWED bit
        CONSTRAINT DF_REALM_EDIT_USERNAME_ALLOWED DEFAULT 0 NOT NULL
GO

CREATE TABLE CLIENT_SESSION_AUTH_STATUS
(
    AUTHENTICATOR  varchar(36) NOT NULL,
    STATUS         int,
    CLIENT_SESSION varchar(36) NOT NULL
)
GO

ALTER TABLE CLIENT_SESSION
    ADD AUTH_USER_ID varchar(36)
GO

ALTER TABLE IDENTITY_PROVIDER
    ADD TRUST_EMAIL bit
        CONSTRAINT DF_IDENTITY_PROVIDER_TRUST_EMAIL DEFAULT 0 NOT NULL
GO

ALTER TABLE IDENTITY_PROVIDER
    ADD UPDATE_PROFILE_FIRST_LGN_MD varchar(255)
        CONSTRAINT DF_IDENTITY_PROVIDER_UPDATE_PROFILE_FIRST_LGN_MD DEFAULT 'on' NOT NULL
GO

UPDATE IDENTITY_PROVIDER
SET UPDATE_PROFILE_FIRST_LGN_MD = 'off'
WHERE UPDATE_PROFILE_FIRST_LOGIN = 0
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE IDENTITY_PROVIDER DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'IDENTITY_PROVIDER')
  AND [c].[name] = N'UPDATE_PROFILE_FIRST_LOGIN'
EXEC sp_executesql @sql
GO

ALTER TABLE IDENTITY_PROVIDER
    DROP COLUMN UPDATE_PROFILE_FIRST_LOGIN
GO

ALTER TABLE USER_REQUIRED_ACTION
    ADD REQUIRED_ACTION varchar(255)
        CONSTRAINT DF_USER_REQUIRED_ACTION_REQUIRED_ACTION DEFAULT ' ' NOT NULL
GO

UPDATE USER_REQUIRED_ACTION
SET REQUIRED_ACTION = 'VERIFY_EMAIL'
WHERE ACTION = 0
GO

UPDATE USER_REQUIRED_ACTION
SET REQUIRED_ACTION = 'UPDATE_PROFILE'
WHERE ACTION = 1
GO

UPDATE USER_REQUIRED_ACTION
SET REQUIRED_ACTION = 'CONFIGURE_TOTP'
WHERE ACTION = 2
GO

UPDATE USER_REQUIRED_ACTION
SET REQUIRED_ACTION = 'UPDATE_PASSWORD'
WHERE ACTION = 3
GO

ALTER TABLE AUTHENTICATOR
    ADD CONSTRAINT CONSTRAINT_AUTH_PK PRIMARY KEY (ID)
GO

ALTER TABLE AUTHENTICATION_FLOW
    ADD CONSTRAINT CONSTRAINT_AUTH_FLOW_PK PRIMARY KEY (ID)
GO

ALTER TABLE AUTHENTICATION_EXECUTION
    ADD CONSTRAINT CONSTRAINT_AUTH_EXEC_PK PRIMARY KEY (ID)
GO

ALTER TABLE AUTHENTICATOR_CONFIG
    ADD CONSTRAINT CONSTRAINT_AUTH_CFG_PK PRIMARY KEY (AUTHENTICATOR_ID, NAME)
GO

ALTER TABLE USER_REQUIRED_ACTION
    DROP CONSTRAINT CONSTRAINT_2
GO

ALTER TABLE USER_REQUIRED_ACTION
    DROP COLUMN ACTION
GO

ALTER TABLE USER_REQUIRED_ACTION
    ADD CONSTRAINT CONSTRAINT_REQUIRED_ACTION PRIMARY KEY (REQUIRED_ACTION, USER_ID)
GO

ALTER TABLE CLIENT_SESSION_AUTH_STATUS
    ADD CONSTRAINT CONSTRAINT_AUTH_STATUS_PK PRIMARY KEY (CLIENT_SESSION, AUTHENTICATOR)
GO

ALTER TABLE USER_FEDERATION_MAPPER
    ADD CONSTRAINT CONSTRAINT_FEDMAPPERPM PRIMARY KEY (ID)
GO

ALTER TABLE USER_FEDERATION_MAPPER_CONFIG
    ADD CONSTRAINT CONSTRAINT_FEDMAPPER_CFG_PM PRIMARY KEY (USER_FEDERATION_MAPPER_ID, NAME)
GO

ALTER TABLE CLIENT_SESSION_AUTH_STATUS
    ADD CONSTRAINT AUTH_STATUS_CONSTRAINT FOREIGN KEY (CLIENT_SESSION) REFERENCES CLIENT_SESSION (ID)
GO

ALTER TABLE AUTHENTICATOR
    ADD CONSTRAINT FK_AUTH_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE AUTHENTICATION_FLOW
    ADD CONSTRAINT FK_AUTH_FLOW_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE AUTHENTICATION_EXECUTION
    ADD CONSTRAINT FK_AUTH_EXEC_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE AUTHENTICATION_EXECUTION
    ADD CONSTRAINT FK_AUTH_EXEC_FLOW FOREIGN KEY (FLOW_ID) REFERENCES AUTHENTICATION_FLOW (ID)
GO

ALTER TABLE USER_FEDERATION_MAPPER
    ADD CONSTRAINT FK_FEDMAPPERPM_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE USER_FEDERATION_MAPPER
    ADD CONSTRAINT FK_FEDMAPPERPM_FEDPRV FOREIGN KEY (FEDERATION_PROVIDER_ID) REFERENCES USER_FEDERATION_PROVIDER (ID)
GO

ALTER TABLE USER_FEDERATION_MAPPER_CONFIG
    ADD CONSTRAINT FK_FEDMAPPER_CFG FOREIGN KEY (USER_FEDERATION_MAPPER_ID) REFERENCES USER_FEDERATION_MAPPER (ID)
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE REALM DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'REALM')
  AND [c].[name] = N'PASSWORD_CRED_GRANT_ALLOWED'
EXEC sp_executesql @sql
GO

ALTER TABLE REALM
    DROP COLUMN PASSWORD_CRED_GRANT_ALLOWED
GO

ALTER TABLE PROTOCOL_MAPPER_CONFIG
    DROP CONSTRAINT FK_PMConfig
GO

ALTER TABLE PROTOCOL_MAPPER_CONFIG
    DROP CONSTRAINT CONSTRAINT_PMConfig
GO

ALTER TABLE PROTOCOL_MAPPER_CONFIG
    ADD CONSTRAINT CONSTRAINT_PMCONFIG PRIMARY KEY (PROTOCOL_MAPPER_ID, NAME)
GO

ALTER TABLE PROTOCOL_MAPPER_CONFIG
    ADD CONSTRAINT FK_PMCONFIG FOREIGN KEY (PROTOCOL_MAPPER_ID) REFERENCES PROTOCOL_MAPPER (ID)
GO

ALTER TABLE IDP_MAPPER_CONFIG
    DROP CONSTRAINT FK_IDPMConfig
GO

ALTER TABLE IDP_MAPPER_CONFIG
    DROP CONSTRAINT CONSTRAINT_IDPMConfig
GO

ALTER TABLE IDP_MAPPER_CONFIG
    ADD CONSTRAINT CONSTRAINT_IDPMCONFIG PRIMARY KEY (IDP_MAPPER_ID, NAME)
GO

ALTER TABLE IDP_MAPPER_CONFIG
    ADD CONSTRAINT FK_IDPMCONFIG FOREIGN KEY (IDP_MAPPER_ID) REFERENCES IDENTITY_PROVIDER_MAPPER (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.3.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-1.3.0.xml', GETDATE(), 10,
        '8:b5f09474dca81fb56a97cf5b6553d331',
        'delete tableName=CLIENT_SESSION_ROLE; delete tableName=CLIENT_SESSION_PROT_MAPPER; delete tableName=CLIENT_SESSION_NOTE; delete tableName=CLIENT_SESSION; delete tableName=USER_SESSION_NOTE; delete tableName=USER_SESSION; createTable tableName=ADMI...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.4.0.xml::1.4.0::bburke@redhat.com
DELETE
FROM CLIENT_SESSION_AUTH_STATUS
GO

DELETE
FROM CLIENT_SESSION_ROLE
GO

DELETE
FROM CLIENT_SESSION_PROT_MAPPER
GO

DELETE
FROM CLIENT_SESSION_NOTE
GO

DELETE
FROM CLIENT_SESSION
GO

DELETE
FROM USER_SESSION_NOTE
GO

DELETE
FROM USER_SESSION
GO

ALTER TABLE CLIENT
    ADD SERVICE_ACCOUNTS_ENABLED bit
        CONSTRAINT DF_CLIENT_SERVICE_ACCOUNTS_ENABLED DEFAULT 0 NOT NULL
GO

ALTER TABLE CLIENT_SESSION
    ADD CURRENT_ACTION varchar(36)
GO

ALTER TABLE AUTHENTICATION_FLOW
    ADD PROVIDER_ID varchar(36)
        CONSTRAINT DF_AUTHENTICATION_FLOW_PROVIDER_ID DEFAULT 'basic-flow' NOT NULL
GO

ALTER TABLE AUTHENTICATION_FLOW
    ADD TOP_LEVEL bit
        CONSTRAINT DF_AUTHENTICATION_FLOW_TOP_LEVEL DEFAULT 0 NOT NULL
GO

ALTER TABLE AUTHENTICATION_FLOW
    ADD BUILT_IN bit
        CONSTRAINT DF_AUTHENTICATION_FLOW_BUILT_IN DEFAULT 0 NOT NULL
GO

ALTER TABLE AUTHENTICATION_EXECUTION
    ADD AUTH_FLOW_ID varchar(36)
GO

ALTER TABLE AUTHENTICATION_EXECUTION
    ADD AUTH_CONFIG varchar(36)
GO

ALTER TABLE USER_ATTRIBUTE
    ADD ID varchar(36)
        CONSTRAINT DF_USER_ATTRIBUTE_ID DEFAULT 'sybase-needs-something-here' NOT NULL
GO

ALTER TABLE AUTHENTICATOR
    DROP COLUMN PROVIDER_ID
GO

exec sp_rename 'AUTHENTICATOR_CONFIG', 'AUTHENTICATOR_CONFIG_ENTRY'
GO

exec sp_rename 'AUTHENTICATOR', 'AUTHENTICATOR_CONFIG'
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'OAUTH_GRANT'
WHERE ACTION = 0
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'CODE_TO_TOKEN'
WHERE ACTION = 1
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'VERIFY_EMAIL'
WHERE ACTION = 2
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'UPDATE_PROFILE'
WHERE ACTION = 3
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'CONFIGURE_TOTP'
WHERE ACTION = 4
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'UPDATE_PASSWORD'
WHERE ACTION = 5
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'RECOVER_PASSWORD'
WHERE ACTION = 6
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'AUTHENTICATE'
WHERE ACTION = 7
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'SOCIAL_CALLBACK'
WHERE ACTION = 8
GO

UPDATE CLIENT_SESSION
SET CURRENT_ACTION = 'LOGGED_OUT'
WHERE ACTION = 9
GO

CREATE TABLE CLIENT_USER_SESSION_NOTE
(
    NAME           varchar(255) NOT NULL,
    VALUE          varchar(2048),
    CLIENT_SESSION varchar(36)  NOT NULL
)
GO

CREATE TABLE REQUIRED_ACTION_PROVIDER
(
    ID             varchar(36)                                          NOT NULL,
    ALIAS          varchar(255),
    NAME           varchar(255),
    REALM_ID       varchar(36),
    ENABLED        bit
        CONSTRAINT DF_REQUIRED_ACTION_PROVIDER_ENABLED DEFAULT 0        NOT NULL,
    DEFAULT_ACTION bit
        CONSTRAINT DF_REQUIRED_ACTION_PROVIDER_DEFAULT_ACTION DEFAULT 0 NOT NULL,
    PROVIDER_ID    varchar(255)
)
GO

CREATE TABLE REQUIRED_ACTION_CONFIG
(
    REQUIRED_ACTION_ID varchar(36)  NOT NULL,
    VALUE              varchar(MAX),
    NAME               varchar(255) NOT NULL
)
GO

-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
ALTER TABLE USER_ATTRIBUTE
    DROP CONSTRAINT CONSTRAINT_6
GO

ALTER TABLE USER_ATTRIBUTE
    ADD CONSTRAINT CONSTRAINT_USER_ATTRIBUTE_PK PRIMARY KEY (ID)
GO

ALTER TABLE REQUIRED_ACTION_PROVIDER
    ADD CONSTRAINT CONSTRAINT_REQ_ACT_PRV_PK PRIMARY KEY (ID)
GO

ALTER TABLE REQUIRED_ACTION_CONFIG
    ADD CONSTRAINT CONSTRAINT_REQ_ACT_CFG_PK PRIMARY KEY (REQUIRED_ACTION_ID, NAME)
GO

ALTER TABLE CLIENT_USER_SESSION_NOTE
    ADD CONSTRAINT CONSTR_CL_USR_SES_NOTE PRIMARY KEY (CLIENT_SESSION, NAME)
GO

ALTER TABLE REQUIRED_ACTION_PROVIDER
    ADD CONSTRAINT FK_REQ_ACT_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE CLIENT_USER_SESSION_NOTE
    ADD CONSTRAINT FK_CL_USR_SES_NOTE FOREIGN KEY (CLIENT_SESSION) REFERENCES CLIENT_SESSION (ID)
GO

ALTER TABLE CLIENT_SESSION
    DROP COLUMN ACTION
GO

ALTER TABLE USER_ENTITY
    ADD CREATED_TIMESTAMP bigint
GO

ALTER TABLE USER_ENTITY
    ADD SERVICE_ACCOUNT_CLIENT_LINK varchar(36)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.4.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-1.4.0.xml', GETDATE(), 11,
        '8:ca924f31bd2a3b219fdcfe78c82dacf4',
        'delete tableName=CLIENT_SESSION_AUTH_STATUS; delete tableName=CLIENT_SESSION_ROLE; delete tableName=CLIENT_SESSION_PROT_MAPPER; delete tableName=CLIENT_SESSION_NOTE; delete tableName=CLIENT_SESSION; delete tableName=USER_SESSION_NOTE; delete table...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/db2-jpa-changelog-1.4.0.xml::1.4.0::bburke@redhat.com
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.4.0', 'bburke@redhat.com', 'META-INF/db2-jpa-changelog-1.4.0.xml', GETDATE(), 12,
        '8:8acad7483e106416bcfa6f3b824a16cd',
        'delete tableName=CLIENT_SESSION_AUTH_STATUS; delete tableName=CLIENT_SESSION_ROLE; delete tableName=CLIENT_SESSION_PROT_MAPPER; delete tableName=CLIENT_SESSION_NOTE; delete tableName=CLIENT_SESSION; delete tableName=USER_SESSION_NOTE; delete table...',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.5.0.xml::1.5.0::bburke@redhat.com
DELETE
FROM CLIENT_SESSION_AUTH_STATUS
GO

DELETE
FROM CLIENT_SESSION_ROLE
GO

DELETE
FROM CLIENT_SESSION_PROT_MAPPER
GO

DELETE
FROM CLIENT_SESSION_NOTE
GO

DELETE
FROM CLIENT_SESSION
GO

DELETE
FROM USER_SESSION_NOTE
GO

DELETE
FROM USER_SESSION
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE AUTHENTICATION_EXECUTION DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'AUTHENTICATION_EXECUTION')
  AND [c].[name] = N'USER_SETUP_ALLOWED'
EXEC sp_executesql @sql
GO

ALTER TABLE AUTHENTICATION_EXECUTION
    DROP COLUMN USER_SETUP_ALLOWED
GO

ALTER TABLE CREDENTIAL
    ADD COUNTER int
        CONSTRAINT DF_CREDENTIAL_COUNTER DEFAULT 0
GO

ALTER TABLE CREDENTIAL
    ADD DIGITS int
        CONSTRAINT DF_CREDENTIAL_DIGITS DEFAULT 6
GO

ALTER TABLE CREDENTIAL
    ADD PERIOD int CONSTRAINT DF_CREDENTIAL_PERIOD DEFAULT 30
GO

ALTER TABLE CREDENTIAL
    ADD ALGORITHM varchar(36)
        CONSTRAINT DF_CREDENTIAL_ALGORITHM DEFAULT 'HmacSHA1'
GO

ALTER TABLE REALM
    ADD OTP_POLICY_COUNTER int
        CONSTRAINT DF_REALM_OTP_POLICY_COUNTER DEFAULT 0
GO

ALTER TABLE REALM
    ADD OTP_POLICY_WINDOW int
        CONSTRAINT DF_REALM_OTP_POLICY_WINDOW DEFAULT 1
GO

ALTER TABLE REALM
    ADD OTP_POLICY_PERIOD int
        CONSTRAINT DF_REALM_OTP_POLICY_PERIOD DEFAULT 30
GO

ALTER TABLE REALM
    ADD OTP_POLICY_DIGITS int
        CONSTRAINT DF_REALM_OTP_POLICY_DIGITS DEFAULT 6
GO

ALTER TABLE REALM
    ADD OTP_POLICY_ALG varchar(36)
        CONSTRAINT DF_REALM_OTP_POLICY_ALG DEFAULT 'HmacSHA1'
GO

ALTER TABLE REALM
    ADD OTP_POLICY_TYPE varchar(36)
        CONSTRAINT DF_REALM_OTP_POLICY_TYPE DEFAULT 'totp'
GO

ALTER TABLE REALM
    ADD BROWSER_FLOW varchar(36)
GO

ALTER TABLE REALM
    ADD REGISTRATION_FLOW varchar(36)
GO

ALTER TABLE REALM
    ADD DIRECT_GRANT_FLOW varchar(36)
GO

ALTER TABLE REALM
    ADD RESET_CREDENTIALS_FLOW varchar(36)
GO

ALTER TABLE REALM
    ADD CLIENT_AUTH_FLOW varchar(36)
GO

ALTER TABLE CLIENT
    ADD CLIENT_AUTHENTICATOR_TYPE varchar(255)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.5.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-1.5.0.xml', GETDATE(), 13,
        '8:9b1266d17f4f87c78226f5055408fd5e',
        'delete tableName=CLIENT_SESSION_AUTH_STATUS; delete tableName=CLIENT_SESSION_ROLE; delete tableName=CLIENT_SESSION_PROT_MAPPER; delete tableName=CLIENT_SESSION_NOTE; delete tableName=CLIENT_SESSION; delete tableName=USER_SESSION_NOTE; delete table...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.6.1.xml::1.6.1_from15::mposolda@redhat.com
ALTER TABLE REALM
    ADD OFFLINE_SESSION_IDLE_TIMEOUT int
        CONSTRAINT DF_REALM_OFFLINE_SESSION_IDLE_TIMEOUT DEFAULT 0
GO

ALTER TABLE REALM
    ADD REVOKE_REFRESH_TOKEN bit
        CONSTRAINT DF_REALM_REVOKE_REFRESH_TOKEN DEFAULT 0 NOT NULL
GO

ALTER TABLE KEYCLOAK_ROLE
    ADD SCOPE_PARAM_REQUIRED bit
        CONSTRAINT DF_KEYCLOAK_ROLE_SCOPE_PARAM_REQUIRED DEFAULT 0 NOT NULL
GO

ALTER TABLE CLIENT
    ADD ROOT_URL varchar(255)
GO

ALTER TABLE CLIENT
    ADD DESCRIPTION varchar(255)
GO

CREATE TABLE OFFLINE_USER_SESSION
(
    USER_SESSION_ID      varchar(36) NOT NULL,
    USER_ID              varchar(36) NOT NULL,
    REALM_ID             varchar(36) NOT NULL,
    LAST_SESSION_REFRESH int,
    OFFLINE_FLAG         varchar(4)  NOT NULL,
    DATA                 varchar(MAX)
)
GO

CREATE TABLE OFFLINE_CLIENT_SESSION
(
    CLIENT_SESSION_ID varchar(36) NOT NULL,
    USER_SESSION_ID   varchar(36) NOT NULL,
    CLIENT_ID         varchar(36) NOT NULL,
    OFFLINE_FLAG      varchar(4)  NOT NULL,
    TIMESTAMP         int,
    DATA              varchar(MAX)
)
GO

ALTER TABLE OFFLINE_USER_SESSION
    ADD CONSTRAINT CONSTRAINT_OFFL_US_SES_PK2 PRIMARY KEY (USER_SESSION_ID, OFFLINE_FLAG)
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ADD CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK2 PRIMARY KEY (CLIENT_SESSION_ID, OFFLINE_FLAG)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.6.1_from15', 'mposolda@redhat.com', 'META-INF/jpa-changelog-1.6.1.xml', GETDATE(), 14,
        '8:d80ec4ab6dbfe573550ff72396c7e910',
        'addColumn tableName=REALM; addColumn tableName=KEYCLOAK_ROLE; addColumn tableName=CLIENT; createTable tableName=OFFLINE_USER_SESSION; createTable tableName=OFFLINE_CLIENT_SESSION; addPrimaryKey constraintName=CONSTRAINT_OFFL_US_SES_PK2, tableName=...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.6.1.xml::1.6.1_from16-pre::mposolda@redhat.com
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.6.1_from16-pre', 'mposolda@redhat.com', 'META-INF/jpa-changelog-1.6.1.xml', GETDATE(), 15,
        '8:d86eb172171e7c20b9c849b584d147b2',
        'delete tableName=OFFLINE_CLIENT_SESSION; delete tableName=OFFLINE_USER_SESSION', '', 'MARK_RAN', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.6.1.xml::1.6.1_from16::mposolda@redhat.com
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.6.1_from16', 'mposolda@redhat.com', 'META-INF/jpa-changelog-1.6.1.xml', GETDATE(), 16,
        '8:5735f46f0fa60689deb0ecdc2a0dea22',
        'dropPrimaryKey constraintName=CONSTRAINT_OFFLINE_US_SES_PK, tableName=OFFLINE_USER_SESSION; dropPrimaryKey constraintName=CONSTRAINT_OFFLINE_CL_SES_PK, tableName=OFFLINE_CLIENT_SESSION; addColumn tableName=OFFLINE_USER_SESSION; update tableName=OF...',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.6.1.xml::1.6.1::mposolda@redhat.com
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.6.1', 'mposolda@redhat.com', 'META-INF/jpa-changelog-1.6.1.xml', GETDATE(), 17,
        '8:d41d8cd98f00b204e9800998ecf8427e', 'empty', '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.7.0.xml::1.7.0::bburke@redhat.com
CREATE TABLE KEYCLOAK_GROUP
(
    ID           varchar(36) NOT NULL,
    NAME         varchar(255),
    PARENT_GROUP varchar(36),
    REALM_ID     varchar(36)
)
GO

CREATE TABLE GROUP_ROLE_MAPPING
(
    ROLE_ID  varchar(36) NOT NULL,
    GROUP_ID varchar(36) NOT NULL
)
GO

CREATE TABLE GROUP_ATTRIBUTE
(
    ID       varchar(36)
        CONSTRAINT DF_GROUP_ATTRIBUTE_ID DEFAULT 'sybase-needs-something-here' NOT NULL,
    NAME     varchar(255)                                                      NOT NULL,
    VALUE    varchar(255),
    GROUP_ID varchar(36)                                                       NOT NULL
)
GO

CREATE TABLE USER_GROUP_MEMBERSHIP
(
    GROUP_ID varchar(36) NOT NULL,
    USER_ID  varchar(36) NOT NULL
)
GO

CREATE TABLE REALM_DEFAULT_GROUPS
(
    REALM_ID varchar(36) NOT NULL,
    GROUP_ID varchar(36) NOT NULL
)
GO

ALTER TABLE IDENTITY_PROVIDER
    ADD FIRST_BROKER_LOGIN_FLOW_ID varchar(36)
GO

ALTER TABLE REALM
    ADD ACCESS_TOKEN_LIFE_IMPLICIT int
        CONSTRAINT DF_REALM_ACCESS_TOKEN_LIFE_IMPLICIT DEFAULT 0
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE IDENTITY_PROVIDER DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'IDENTITY_PROVIDER')
  AND [c].[name] = N'UPDATE_PROFILE_FIRST_LGN_MD'
EXEC sp_executesql @sql
GO

ALTER TABLE IDENTITY_PROVIDER
    DROP COLUMN UPDATE_PROFILE_FIRST_LGN_MD
GO

ALTER TABLE KEYCLOAK_GROUP
    ADD CONSTRAINT CONSTRAINT_GROUP PRIMARY KEY (ID)
GO

ALTER TABLE KEYCLOAK_GROUP
    ADD CONSTRAINT FK_GROUP_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE GROUP_ATTRIBUTE
    ADD CONSTRAINT CONSTRAINT_GROUP_ATTRIBUTE_PK PRIMARY KEY (ID)
GO

ALTER TABLE GROUP_ATTRIBUTE
    ADD CONSTRAINT FK_GROUP_ATTRIBUTE_GROUP FOREIGN KEY (GROUP_ID) REFERENCES KEYCLOAK_GROUP (ID)
GO

ALTER TABLE USER_GROUP_MEMBERSHIP
    ADD CONSTRAINT CONSTRAINT_USER_GROUP PRIMARY KEY (GROUP_ID, USER_ID)
GO

ALTER TABLE USER_GROUP_MEMBERSHIP
    ADD CONSTRAINT FK_USER_GROUP_USER FOREIGN KEY (USER_ID) REFERENCES USER_ENTITY (ID)
GO

ALTER TABLE GROUP_ROLE_MAPPING
    ADD CONSTRAINT CONSTRAINT_GROUP_ROLE PRIMARY KEY (ROLE_ID, GROUP_ID)
GO

ALTER TABLE GROUP_ROLE_MAPPING
    ADD CONSTRAINT FK_GROUP_ROLE_GROUP FOREIGN KEY (GROUP_ID) REFERENCES KEYCLOAK_GROUP (ID)
GO

ALTER TABLE GROUP_ROLE_MAPPING
    ADD CONSTRAINT FK_GROUP_ROLE_ROLE FOREIGN KEY (ROLE_ID) REFERENCES KEYCLOAK_ROLE (ID)
GO

ALTER TABLE REALM_DEFAULT_GROUPS
    ADD CONSTRAINT CON_GROUP_ID_DEF_GROUPS UNIQUE (GROUP_ID)
GO

ALTER TABLE REALM_DEFAULT_GROUPS
    ADD CONSTRAINT FK_DEF_GROUPS_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE REALM_DEFAULT_GROUPS
    ADD CONSTRAINT FK_DEF_GROUPS_GROUP FOREIGN KEY (GROUP_ID) REFERENCES KEYCLOAK_GROUP (ID)
GO

ALTER TABLE CLIENT
    ADD REGISTRATION_TOKEN varchar(255)
GO

ALTER TABLE CLIENT
    ADD STANDARD_FLOW_ENABLED bit
        CONSTRAINT DF_CLIENT_STANDARD_FLOW_ENABLED DEFAULT 1 NOT NULL
GO

ALTER TABLE CLIENT
    ADD IMPLICIT_FLOW_ENABLED bit
        CONSTRAINT DF_CLIENT_IMPLICIT_FLOW_ENABLED DEFAULT 0 NOT NULL
GO

ALTER TABLE CLIENT
    ADD DIRECT_ACCESS_GRANTS_ENABLED bit
        CONSTRAINT DF_CLIENT_DIRECT_ACCESS_GRANTS_ENABLED DEFAULT 0 NOT NULL
GO

UPDATE CLIENT
SET DIRECT_ACCESS_GRANTS_ENABLED = 1,
    STANDARD_FLOW_ENABLED        = 0
WHERE DIRECT_GRANTS_ONLY = 1
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT')
  AND [c].[name] = N'DIRECT_GRANTS_ONLY'
EXEC sp_executesql @sql
GO

ALTER TABLE CLIENT
    DROP COLUMN DIRECT_GRANTS_ONLY
GO

ALTER TABLE REALM
    ALTER COLUMN PASSWORD_POLICY varchar(2550)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.7.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-1.7.0.xml', GETDATE(), 18,
        '8:5c1a8fd2014ac7fc43b90a700f117b23',
        'createTable tableName=KEYCLOAK_GROUP; createTable tableName=GROUP_ROLE_MAPPING; createTable tableName=GROUP_ATTRIBUTE; createTable tableName=USER_GROUP_MEMBERSHIP; createTable tableName=REALM_DEFAULT_GROUPS; addColumn tableName=IDENTITY_PROVIDER; ...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.8.0.xml::1.8.0::mposolda@redhat.com
ALTER TABLE IDENTITY_PROVIDER
    ADD POST_BROKER_LOGIN_FLOW_ID varchar(36)
GO

CREATE TABLE CLIENT_TEMPLATE
(
    ID                           varchar(36)                                 NOT NULL,
    NAME                         varchar(255),
    REALM_ID                     varchar(36),
    DESCRIPTION                  varchar(255),
    PROTOCOL                     varchar(255),
    FULL_SCOPE_ALLOWED           bit
        CONSTRAINT DF_CLIENT_TEMPLATE_FULL_SCOPE_ALLOWED DEFAULT 0           NOT NULL,
    CONSENT_REQUIRED             bit
        CONSTRAINT DF_CLIENT_TEMPLATE_CONSENT_REQUIRED DEFAULT 0             NOT NULL,
    STANDARD_FLOW_ENABLED        bit
        CONSTRAINT DF_CLIENT_TEMPLATE_STANDARD_FLOW_ENABLED DEFAULT 1        NOT NULL,
    IMPLICIT_FLOW_ENABLED        bit
        CONSTRAINT DF_CLIENT_TEMPLATE_IMPLICIT_FLOW_ENABLED DEFAULT 0        NOT NULL,
    DIRECT_ACCESS_GRANTS_ENABLED bit
        CONSTRAINT DF_CLIENT_TEMPLATE_DIRECT_ACCESS_GRANTS_ENABLED DEFAULT 0 NOT NULL,
    SERVICE_ACCOUNTS_ENABLED     bit
        CONSTRAINT DF_CLIENT_TEMPLATE_SERVICE_ACCOUNTS_ENABLED DEFAULT 0     NOT NULL,
    FRONTCHANNEL_LOGOUT          bit
        CONSTRAINT DF_CLIENT_TEMPLATE_FRONTCHANNEL_LOGOUT DEFAULT 0          NOT NULL,
    BEARER_ONLY                  bit
        CONSTRAINT DF_CLIENT_TEMPLATE_BEARER_ONLY DEFAULT 0                  NOT NULL,
    PUBLIC_CLIENT                bit
        CONSTRAINT DF_CLIENT_TEMPLATE_PUBLIC_CLIENT DEFAULT 0                NOT NULL
)
GO

CREATE TABLE CLIENT_TEMPLATE_ATTRIBUTES
(
    TEMPLATE_ID varchar(36)  NOT NULL,
    VALUE       varchar(2048),
    NAME        varchar(255) NOT NULL
)
GO

CREATE TABLE TEMPLATE_SCOPE_MAPPING
(
    TEMPLATE_ID varchar(36) NOT NULL,
    ROLE_ID     varchar(36) NOT NULL
)
GO

ALTER TABLE PROTOCOL_MAPPER
    ALTER COLUMN CLIENT_ID varchar(36) NULL
GO

ALTER TABLE CLIENT
    ADD CLIENT_TEMPLATE_ID varchar(36)
GO

ALTER TABLE CLIENT
    ADD USE_TEMPLATE_CONFIG bit
        CONSTRAINT DF_CLIENT_USE_TEMPLATE_CONFIG DEFAULT 0 NOT NULL
GO

ALTER TABLE CLIENT
    ADD USE_TEMPLATE_SCOPE bit
        CONSTRAINT DF_CLIENT_USE_TEMPLATE_SCOPE DEFAULT 0 NOT NULL
GO

ALTER TABLE CLIENT
    ADD USE_TEMPLATE_MAPPERS bit
        CONSTRAINT DF_CLIENT_USE_TEMPLATE_MAPPERS DEFAULT 0 NOT NULL
GO

ALTER TABLE PROTOCOL_MAPPER
    ADD CLIENT_TEMPLATE_ID varchar(36)
GO

CREATE TABLE REALM_CLIENT_TEMPLATE
(
    CLIENT_TEMPLATE_ID varchar(36) NOT NULL,
    REALM_ID           varchar(36) NOT NULL
)
GO

ALTER TABLE CLIENT_TEMPLATE
    ADD CONSTRAINT PK_CLI_TEMPLATE PRIMARY KEY (ID)
GO

ALTER TABLE CLIENT_TEMPLATE
    ADD CONSTRAINT UK_CLI_TEMPLATE UNIQUE (REALM_ID, NAME)
GO

ALTER TABLE CLIENT_TEMPLATE
    ADD CONSTRAINT FK_REALM_CLI_TMPLT FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE PROTOCOL_MAPPER
    ADD CONSTRAINT FK_CLI_TMPLT_MAPPER FOREIGN KEY (CLIENT_TEMPLATE_ID) REFERENCES CLIENT_TEMPLATE (ID)
GO

ALTER TABLE CLIENT
    ADD CONSTRAINT FK_CLI_TMPLT_CLIENT FOREIGN KEY (CLIENT_TEMPLATE_ID) REFERENCES CLIENT_TEMPLATE (ID)
GO

ALTER TABLE REALM_CLIENT_TEMPLATE
    ADD CONSTRAINT FK_RLM_CLI_TMPLT_RLM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE REALM_CLIENT_TEMPLATE
    ADD CONSTRAINT FK_RLM_CLI_TMPLT_CLI FOREIGN KEY (CLIENT_TEMPLATE_ID) REFERENCES CLIENT_TEMPLATE (ID)
GO

ALTER TABLE TEMPLATE_SCOPE_MAPPING
    ADD CONSTRAINT PK_TEMPLATE_SCOPE PRIMARY KEY (TEMPLATE_ID, ROLE_ID)
GO

ALTER TABLE TEMPLATE_SCOPE_MAPPING
    ADD CONSTRAINT FK_TEMPL_SCOPE_TEMPL FOREIGN KEY (TEMPLATE_ID) REFERENCES CLIENT_TEMPLATE (ID)
GO

ALTER TABLE TEMPLATE_SCOPE_MAPPING
    ADD CONSTRAINT FK_TEMPL_SCOPE_ROLE FOREIGN KEY (ROLE_ID) REFERENCES KEYCLOAK_ROLE (ID)
GO

ALTER TABLE CLIENT_TEMPLATE_ATTRIBUTES
    ADD CONSTRAINT PK_CL_TMPL_ATTR PRIMARY KEY (TEMPLATE_ID, NAME)
GO

ALTER TABLE CLIENT_TEMPLATE_ATTRIBUTES
    ADD CONSTRAINT FK_CL_TEMPL_ATTR_TEMPL FOREIGN KEY (TEMPLATE_ID) REFERENCES CLIENT_TEMPLATE (ID)
GO

UPDATE CREDENTIAL
SET ALGORITHM = 'pbkdf2'
WHERE TYPE in ('password-history', 'password')
  AND ALGORITHM is NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.8.0', 'mposolda@redhat.com', 'META-INF/jpa-changelog-1.8.0.xml', GETDATE(), 19,
        '8:1f6c2c2dfc362aff4ed75b3f0ef6b331',
        'addColumn tableName=IDENTITY_PROVIDER; createTable tableName=CLIENT_TEMPLATE; createTable tableName=CLIENT_TEMPLATE_ATTRIBUTES; createTable tableName=TEMPLATE_SCOPE_MAPPING; dropNotNullConstraint columnName=CLIENT_ID, tableName=PROTOCOL_MAPPER; ad...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.8.0.xml::1.8.0-2::keycloak
DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CREDENTIAL')
  AND [c].[name] = N'ALGORITHM'
EXEC sp_executesql @sql
GO

UPDATE CREDENTIAL
SET ALGORITHM = 'pbkdf2'
WHERE TYPE in ('password-history', 'password')
  AND ALGORITHM = 'HmacSHA1'
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.8.0-2', 'keycloak', 'META-INF/jpa-changelog-1.8.0.xml', GETDATE(), 20, '8:dee9246280915712591f83a127665107',
        'dropDefaultValue columnName=ALGORITHM, tableName=CREDENTIAL; update tableName=CREDENTIAL', '', 'EXECUTED',
        NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/db2-jpa-changelog-1.8.0.xml::1.8.0::mposolda@redhat.com
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.8.0', 'mposolda@redhat.com', 'META-INF/db2-jpa-changelog-1.8.0.xml', GETDATE(), 21,
        '8:9eb2ee1fa8ad1c5e426421a6f8fdfa6a',
        'addColumn tableName=IDENTITY_PROVIDER; createTable tableName=CLIENT_TEMPLATE; createTable tableName=CLIENT_TEMPLATE_ATTRIBUTES; createTable tableName=TEMPLATE_SCOPE_MAPPING; dropNotNullConstraint columnName=CLIENT_ID, tableName=PROTOCOL_MAPPER; ad...',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/db2-jpa-changelog-1.8.0.xml::1.8.0-2::keycloak
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.8.0-2', 'keycloak', 'META-INF/db2-jpa-changelog-1.8.0.xml', GETDATE(), 22,
        '8:dee9246280915712591f83a127665107',
        'dropDefaultValue columnName=ALGORITHM, tableName=CREDENTIAL; update tableName=CREDENTIAL', '', 'MARK_RAN',
        NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.9.0.xml::1.9.0::mposolda@redhat.com
UPDATE REALM
SET OTP_POLICY_COUNTER = 0
WHERE OTP_POLICY_COUNTER is NULL
GO

UPDATE REALM
SET OTP_POLICY_WINDOW = 1
WHERE OTP_POLICY_WINDOW is NULL
GO

UPDATE REALM
SET OTP_POLICY_PERIOD = 30
WHERE OTP_POLICY_PERIOD is NULL
GO

UPDATE REALM
SET OTP_POLICY_DIGITS = 6
WHERE OTP_POLICY_DIGITS is NULL
GO

UPDATE CREDENTIAL
SET COUNTER = 0
WHERE COUNTER is NULL
GO

UPDATE CREDENTIAL
SET DIGITS = 6
WHERE DIGITS is NULL
GO

UPDATE CREDENTIAL
SET PERIOD = 30
WHERE PERIOD is NULL
GO

UPDATE REALM
SET OFFLINE_SESSION_IDLE_TIMEOUT = 2592000
WHERE OFFLINE_SESSION_IDLE_TIMEOUT is NULL
GO

UPDATE REALM
SET ACCESS_TOKEN_LIFE_IMPLICIT = 900
WHERE ACCESS_TOKEN_LIFE_IMPLICIT is NULL
GO

-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
ALTER TABLE REALM_CLIENT
    DROP CONSTRAINT FK_93S3P0DIUXAWWQQSA528UBY2Q
GO

ALTER TABLE REALM_CLIENT
    DROP CONSTRAINT FK_M6QGA3RFME47335JY8JXYXH3I
GO

ALTER TABLE REALM_CLIENT
    DROP CONSTRAINT UK_M6QGA3RFME47335JY8JXYXH3I
GO

DROP TABLE REALM_CLIENT
GO

ALTER TABLE REALM_CLIENT_TEMPLATE
    DROP CONSTRAINT FK_RLM_CLI_TMPLT_RLM
GO

ALTER TABLE REALM_CLIENT_TEMPLATE
    DROP CONSTRAINT FK_RLM_CLI_TMPLT_CLI
GO

DROP TABLE REALM_CLIENT_TEMPLATE
GO

ALTER TABLE FED_PROVIDERS
    DROP CONSTRAINT FK_213LYQ09FKXQ8K8NY8DY3737T
GO

ALTER TABLE FED_PROVIDERS
    DROP CONSTRAINT FK_DCCIRJLIPU1478VQC89DID88C
GO

ALTER TABLE FED_PROVIDERS
    DROP CONSTRAINT UK_DCCIRJLIPU1478VQC89DID88C
GO

DROP TABLE FED_PROVIDERS
GO

CREATE NONCLUSTERED INDEX IDX_US_SESS_ID_ON_CL_SESS ON OFFLINE_CLIENT_SESSION (USER_SESSION_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.9.0', 'mposolda@redhat.com', 'META-INF/jpa-changelog-1.9.0.xml', GETDATE(), 23,
        '8:d9fa18ffa355320395b86270680dd4fe',
        'update tableName=REALM; update tableName=REALM; update tableName=REALM; update tableName=REALM; update tableName=CREDENTIAL; update tableName=CREDENTIAL; update tableName=CREDENTIAL; update tableName=REALM; update tableName=REALM; customChange; dr...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.9.1.xml::1.9.1::keycloak
ALTER TABLE REALM
    ALTER COLUMN PRIVATE_KEY varchar(4000)
GO

ALTER TABLE REALM
    ALTER COLUMN PUBLIC_KEY varchar(4000)
GO

ALTER TABLE REALM
    ALTER COLUMN CERTIFICATE varchar(4000)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.9.1', 'keycloak', 'META-INF/jpa-changelog-1.9.1.xml', GETDATE(), 24, '8:90cff506fedb06141ffc1c71c4a1214c',
        'modifyDataType columnName=PRIVATE_KEY, tableName=REALM; modifyDataType columnName=PUBLIC_KEY, tableName=REALM; modifyDataType columnName=CERTIFICATE, tableName=REALM',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/db2-jpa-changelog-1.9.1.xml::1.9.1::keycloak
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.9.1', 'keycloak', 'META-INF/db2-jpa-changelog-1.9.1.xml', GETDATE(), 25,
        '8:11a788aed4961d6d29c427c063af828c',
        'modifyDataType columnName=PRIVATE_KEY, tableName=REALM; modifyDataType columnName=CERTIFICATE, tableName=REALM',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-1.9.2.xml::1.9.2::keycloak
CREATE NONCLUSTERED INDEX IDX_USER_EMAIL ON USER_ENTITY (EMAIL)
GO

CREATE NONCLUSTERED INDEX IDX_USER_ROLE_MAPPING ON USER_ROLE_MAPPING (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USER_GROUP_MAPPING ON USER_GROUP_MEMBERSHIP (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USER_CONSENT ON USER_CONSENT (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CONSENT_PROTMAPPER ON USER_CONSENT_PROT_MAPPER (USER_CONSENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CONSENT_ROLE ON USER_CONSENT_ROLE (USER_CONSENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USER_ATTRIBUTE ON USER_ATTRIBUTE (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USER_CREDENTIAL ON CREDENTIAL (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USER_REQACTIONS ON USER_REQUIRED_ACTION (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FEDIDENTITY_USER ON FEDERATED_IDENTITY (USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FEDIDENTITY_FEDUSER ON FEDERATED_IDENTITY (FEDERATED_USER_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('1.9.2', 'keycloak', 'META-INF/jpa-changelog-1.9.2.xml', GETDATE(), 26, '8:a4218e51e1faf380518cce2af5d39b43',
        'createIndex indexName=IDX_USER_EMAIL, tableName=USER_ENTITY; createIndex indexName=IDX_USER_ROLE_MAPPING, tableName=USER_ROLE_MAPPING; createIndex indexName=IDX_USER_GROUP_MAPPING, tableName=USER_GROUP_MEMBERSHIP; createIndex indexName=IDX_USER_CO...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-2.0.0.xml::authz-2.0.0::psilva@redhat.com
CREATE TABLE RESOURCE_SERVER
(
    ID                   varchar(36)                                 NOT NULL,
    CLIENT_ID            varchar(36)                                 NOT NULL,
    ALLOW_RS_REMOTE_MGMT bit
        CONSTRAINT DF_RESOURCE_SERVER_ALLOW_RS_REMOTE_MGMT DEFAULT 0 NOT NULL,
    POLICY_ENFORCE_MODE  varchar(15)                                 NOT NULL
)
GO

ALTER TABLE RESOURCE_SERVER
    ADD CONSTRAINT CONSTRAINT_FARS PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_SERVER
    ADD CONSTRAINT UK_AU8TT6T700S9V50BU18WS5HA6 UNIQUE (CLIENT_ID)
GO

CREATE TABLE RESOURCE_SERVER_RESOURCE
(
    ID                 varchar(36)  NOT NULL,
    NAME               varchar(255) NOT NULL,
    URI                varchar(255),
    TYPE               varchar(255),
    ICON_URI           varchar(255),
    OWNER              varchar(36)  NOT NULL,
    RESOURCE_SERVER_ID varchar(36)  NOT NULL
)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD CONSTRAINT CONSTRAINT_FARSR PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD CONSTRAINT FK_FRSRHO213XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD CONSTRAINT UK_FRSR6T700S9V50BU18WS5HA6 UNIQUE (NAME, OWNER, RESOURCE_SERVER_ID)
GO

CREATE TABLE RESOURCE_SERVER_SCOPE
(
    ID                 varchar(36)  NOT NULL,
    NAME               varchar(255) NOT NULL,
    ICON_URI           varchar(255),
    RESOURCE_SERVER_ID varchar(36)  NOT NULL
)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD CONSTRAINT CONSTRAINT_FARSRS PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD CONSTRAINT FK_FRSRSO213XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD CONSTRAINT UK_FRSRST700S9V50BU18WS5HA6 UNIQUE (NAME, RESOURCE_SERVER_ID)
GO

CREATE TABLE RESOURCE_SERVER_POLICY
(
    ID                 varchar(36)  NOT NULL,
    NAME               varchar(255) NOT NULL,
    DESCRIPTION        varchar(255),
    TYPE               varchar(255) NOT NULL,
    DECISION_STRATEGY  varchar(20),
    LOGIC              varchar(20),
    RESOURCE_SERVER_ID varchar(36)  NOT NULL
)
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ADD CONSTRAINT CONSTRAINT_FARSRP PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ADD CONSTRAINT FK_FRSRPO213XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ADD CONSTRAINT UK_FRSRPT700S9V50BU18WS5HA6 UNIQUE (NAME, RESOURCE_SERVER_ID)
GO

CREATE TABLE POLICY_CONFIG
(
    POLICY_ID varchar(36)  NOT NULL,
    NAME      varchar(255) NOT NULL,
    VALUE     varchar(MAX)
)
GO

ALTER TABLE POLICY_CONFIG
    ADD CONSTRAINT CONSTRAINT_DPC PRIMARY KEY (POLICY_ID, NAME)
GO

ALTER TABLE POLICY_CONFIG
    ADD CONSTRAINT FKDC34197CF864C4E43 FOREIGN KEY (POLICY_ID) REFERENCES RESOURCE_SERVER_POLICY (ID)
GO

CREATE TABLE RESOURCE_SCOPE
(
    RESOURCE_ID varchar(36) NOT NULL,
    SCOPE_ID    varchar(36) NOT NULL
)
GO

ALTER TABLE RESOURCE_SCOPE
    ADD CONSTRAINT CONSTRAINT_FARSRSP PRIMARY KEY (RESOURCE_ID, SCOPE_ID)
GO

ALTER TABLE RESOURCE_SCOPE
    ADD CONSTRAINT FK_FRSRPOS13XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_ID) REFERENCES RESOURCE_SERVER_RESOURCE (ID)
GO

ALTER TABLE RESOURCE_SCOPE
    ADD CONSTRAINT FK_FRSRPS213XCX4WNKOG82SSRFY FOREIGN KEY (SCOPE_ID) REFERENCES RESOURCE_SERVER_SCOPE (ID)
GO

CREATE TABLE RESOURCE_POLICY
(
    RESOURCE_ID varchar(36) NOT NULL,
    POLICY_ID   varchar(36) NOT NULL
)
GO

ALTER TABLE RESOURCE_POLICY
    ADD CONSTRAINT CONSTRAINT_FARSRPP PRIMARY KEY (RESOURCE_ID, POLICY_ID)
GO

ALTER TABLE RESOURCE_POLICY
    ADD CONSTRAINT FK_FRSRPOS53XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_ID) REFERENCES RESOURCE_SERVER_RESOURCE (ID)
GO

ALTER TABLE RESOURCE_POLICY
    ADD CONSTRAINT FK_FRSRPP213XCX4WNKOG82SSRFY FOREIGN KEY (POLICY_ID) REFERENCES RESOURCE_SERVER_POLICY (ID)
GO

CREATE TABLE SCOPE_POLICY
(
    SCOPE_ID  varchar(36) NOT NULL,
    POLICY_ID varchar(36) NOT NULL
)
GO

ALTER TABLE SCOPE_POLICY
    ADD CONSTRAINT CONSTRAINT_FARSRSPS PRIMARY KEY (SCOPE_ID, POLICY_ID)
GO

ALTER TABLE SCOPE_POLICY
    ADD CONSTRAINT FK_FRSRPASS3XCX4WNKOG82SSRFY FOREIGN KEY (SCOPE_ID) REFERENCES RESOURCE_SERVER_SCOPE (ID)
GO

ALTER TABLE SCOPE_POLICY
    ADD CONSTRAINT FK_FRSRASP13XCX4WNKOG82SSRFY FOREIGN KEY (POLICY_ID) REFERENCES RESOURCE_SERVER_POLICY (ID)
GO

CREATE TABLE ASSOCIATED_POLICY
(
    POLICY_ID            varchar(36) NOT NULL,
    ASSOCIATED_POLICY_ID varchar(36) NOT NULL
)
GO

ALTER TABLE ASSOCIATED_POLICY
    ADD CONSTRAINT CONSTRAINT_FARSRPAP PRIMARY KEY (POLICY_ID, ASSOCIATED_POLICY_ID)
GO

ALTER TABLE ASSOCIATED_POLICY
    ADD CONSTRAINT FK_FRSRPAS14XCX4WNKOG82SSRFY FOREIGN KEY (POLICY_ID) REFERENCES RESOURCE_SERVER_POLICY (ID)
GO

ALTER TABLE ASSOCIATED_POLICY
    ADD CONSTRAINT FK_FRSR5S213XCX4WNKOG82SSRFY FOREIGN KEY (ASSOCIATED_POLICY_ID) REFERENCES RESOURCE_SERVER_POLICY (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-2.0.0', 'psilva@redhat.com', 'META-INF/jpa-changelog-authz-2.0.0.xml', GETDATE(), 27,
        '8:d9e9a1bfaa644da9952456050f07bbdc',
        'createTable tableName=RESOURCE_SERVER; addPrimaryKey constraintName=CONSTRAINT_FARS, tableName=RESOURCE_SERVER; addUniqueConstraint constraintName=UK_AU8TT6T700S9V50BU18WS5HA6, tableName=RESOURCE_SERVER; createTable tableName=RESOURCE_SERVER_RESOU...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-2.5.1.xml::authz-2.5.1::psilva@redhat.com
UPDATE RESOURCE_SERVER_POLICY
SET TYPE = 'rules'
WHERE TYPE = 'drools'
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-2.5.1', 'psilva@redhat.com', 'META-INF/jpa-changelog-authz-2.5.1.xml', GETDATE(), 28,
        '8:d1bf991a6163c0acbfe664b615314505', 'update tableName=RESOURCE_SERVER_POLICY', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.1.0.xml::2.1.0-KEYCLOAK-5461::bburke@redhat.com
CREATE TABLE BROKER_LINK
(
    IDENTITY_PROVIDER   varchar(255) NOT NULL,
    STORAGE_PROVIDER_ID varchar(255),
    REALM_ID            varchar(36)  NOT NULL,
    BROKER_USER_ID      varchar(255),
    BROKER_USERNAME     varchar(255),
    TOKEN               varchar(max),
    USER_ID             varchar(255) NOT NULL
)
GO

CREATE TABLE FED_USER_ATTRIBUTE
(
    ID                  varchar(36)  NOT NULL,
    NAME                varchar(255) NOT NULL,
    USER_ID             varchar(255) NOT NULL,
    REALM_ID            varchar(36)  NOT NULL,
    STORAGE_PROVIDER_ID varchar(36),
    VALUE               varchar(2024)
)
GO

CREATE TABLE FED_USER_CONSENT
(
    ID                  varchar(36)  NOT NULL,
    CLIENT_ID           varchar(36)  NOT NULL,
    USER_ID             varchar(255) NOT NULL,
    REALM_ID            varchar(36)  NOT NULL,
    STORAGE_PROVIDER_ID varchar(36)
)
GO

CREATE TABLE FED_USER_CONSENT_ROLE
(
    USER_CONSENT_ID varchar(36) NOT NULL,
    ROLE_ID         varchar(36) NOT NULL
)
GO

CREATE TABLE FED_USER_CONSENT_PROT_MAPPER
(
    USER_CONSENT_ID    varchar(36) NOT NULL,
    PROTOCOL_MAPPER_ID varchar(36) NOT NULL
)
GO

CREATE TABLE FED_USER_CREDENTIAL
(
    ID                  varchar(36)  NOT NULL,
    DEVICE              varchar(255),
    HASH_ITERATIONS     int,
    SALT                varbinary(16),
    TYPE                varchar(255),
    VALUE               varchar(255),
    CREATED_DATE        bigint,
    COUNTER             int
        CONSTRAINT DF_FED_USER_CREDENTIAL_COUNTER DEFAULT 0,
    DIGITS              int
        CONSTRAINT DF_FED_USER_CREDENTIAL_DIGITS DEFAULT 6,
    PERIOD int CONSTRAINT DF_FED_USER_CREDENTIAL_PERIOD DEFAULT 30,
    ALGORITHM           varchar(36)
        CONSTRAINT DF_FED_USER_CREDENTIAL_ALGORITHM DEFAULT 'HmacSHA1',
    USER_ID             varchar(255) NOT NULL,
    REALM_ID            varchar(36)  NOT NULL,
    STORAGE_PROVIDER_ID varchar(36)
)
GO

CREATE TABLE FED_USER_GROUP_MEMBERSHIP
(
    GROUP_ID            varchar(36)  NOT NULL,
    USER_ID             varchar(255) NOT NULL,
    REALM_ID            varchar(36)  NOT NULL,
    STORAGE_PROVIDER_ID varchar(36)
)
GO

CREATE TABLE FED_USER_REQUIRED_ACTION
(
    REQUIRED_ACTION     varchar(255)
        CONSTRAINT DF_FED_USER_REQUIRED_ACTION_REQUIRED_ACTION DEFAULT ' ' NOT NULL,
    USER_ID             varchar(255)                                       NOT NULL,
    REALM_ID            varchar(36)                                        NOT NULL,
    STORAGE_PROVIDER_ID varchar(36)
)
GO

CREATE TABLE FED_USER_ROLE_MAPPING
(
    ROLE_ID             varchar(36)  NOT NULL,
    USER_ID             varchar(255) NOT NULL,
    REALM_ID            varchar(36)  NOT NULL,
    STORAGE_PROVIDER_ID varchar(36)
)
GO

CREATE TABLE COMPONENT_CONFIG
(
    ID           varchar(36)  NOT NULL,
    COMPONENT_ID varchar(36)  NOT NULL,
    NAME         varchar(255) NOT NULL,
    VALUE        varchar(4000)
)
GO

CREATE TABLE COMPONENT
(
    ID            varchar(36) NOT NULL,
    NAME          varchar(255),
    PARENT_ID     varchar(36),
    PROVIDER_ID   varchar(36),
    PROVIDER_TYPE varchar(255),
    REALM_ID      varchar(36)
)
GO

ALTER TABLE BROKER_LINK
    ADD CONSTRAINT CONSTR_BROKER_LINK_PK PRIMARY KEY (IDENTITY_PROVIDER, USER_ID)
GO

ALTER TABLE FED_USER_ATTRIBUTE
    ADD CONSTRAINT CONSTR_FED_USER_ATTR_PK PRIMARY KEY (ID)
GO

ALTER TABLE FED_USER_CONSENT
    ADD CONSTRAINT CONSTR_FED_USER_CONSENT_PK PRIMARY KEY (ID)
GO

ALTER TABLE FED_USER_CONSENT_ROLE
    ADD CONSTRAINT CONSTR_USER_CONSENT_ROLE_PK PRIMARY KEY (USER_CONSENT_ID, ROLE_ID)
GO

ALTER TABLE FED_USER_CONSENT_PROT_MAPPER
    ADD CONSTRAINT CONSTR_USER_CONSENT_PROTM_PK PRIMARY KEY (USER_CONSENT_ID, PROTOCOL_MAPPER_ID)
GO

ALTER TABLE FED_USER_CREDENTIAL
    ADD CONSTRAINT CONSTR_FED_USER_CRED_PK PRIMARY KEY (ID)
GO

ALTER TABLE FED_USER_GROUP_MEMBERSHIP
    ADD CONSTRAINT CONSTR_FED_USER_GROUP PRIMARY KEY (GROUP_ID, USER_ID)
GO

ALTER TABLE FED_USER_ROLE_MAPPING
    ADD CONSTRAINT CONSTR_FED_USER_ROLE PRIMARY KEY (ROLE_ID, USER_ID)
GO

ALTER TABLE FED_USER_REQUIRED_ACTION
    ADD CONSTRAINT CONSTR_FED_REQUIRED_ACTION PRIMARY KEY (REQUIRED_ACTION, USER_ID)
GO

ALTER TABLE COMPONENT
    ADD CONSTRAINT CONSTR_COMPONENT_PK PRIMARY KEY (ID)
GO

ALTER TABLE COMPONENT_CONFIG
    ADD CONSTRAINT CONSTR_COMPONENT_CONFIG_PK PRIMARY KEY (ID)
GO

ALTER TABLE COMPONENT
    ADD CONSTRAINT FK_COMPONENT_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE COMPONENT_CONFIG
    ADD CONSTRAINT FK_COMPONENT_CONFIG FOREIGN KEY (COMPONENT_ID) REFERENCES COMPONENT (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.1.0-KEYCLOAK-5461', 'bburke@redhat.com', 'META-INF/jpa-changelog-2.1.0.xml', GETDATE(), 29,
        '8:88a743a1e87ec5e30bf603da68058a8c',
        'createTable tableName=BROKER_LINK; createTable tableName=FED_USER_ATTRIBUTE; createTable tableName=FED_USER_CONSENT; createTable tableName=FED_USER_CONSENT_ROLE; createTable tableName=FED_USER_CONSENT_PROT_MAPPER; createTable tableName=FED_USER_CR...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.2.0.xml::2.2.0::bburke@redhat.com
ALTER TABLE ADMIN_EVENT_ENTITY
    ADD RESOURCE_TYPE varchar(64)
GO

CREATE TABLE CREDENTIAL_ATTRIBUTE
(
    ID            varchar(36)  NOT NULL,
    CREDENTIAL_ID varchar(36)  NOT NULL,
    NAME          varchar(255) NOT NULL,
    VALUE         varchar(4000)
)
GO

CREATE TABLE FED_CREDENTIAL_ATTRIBUTE
(
    ID            varchar(36)  NOT NULL,
    CREDENTIAL_ID varchar(36)  NOT NULL,
    NAME          varchar(255) NOT NULL,
    VALUE         varchar(4000)
)
GO

ALTER TABLE CREDENTIAL
    ALTER COLUMN VALUE varchar(4000)
GO

ALTER TABLE FED_CREDENTIAL_ATTRIBUTE
    ADD CONSTRAINT FK_FED_CRED_ATTR FOREIGN KEY (CREDENTIAL_ID) REFERENCES FED_USER_CREDENTIAL (ID)
GO

ALTER TABLE CREDENTIAL_ATTRIBUTE
    ADD CONSTRAINT FK_CRED_ATTR FOREIGN KEY (CREDENTIAL_ID) REFERENCES CREDENTIAL (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.2.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-2.2.0.xml', GETDATE(), 30,
        '8:c5517863c875d325dea463d00ec26d7a',
        'addColumn tableName=ADMIN_EVENT_ENTITY; createTable tableName=CREDENTIAL_ATTRIBUTE; createTable tableName=FED_CREDENTIAL_ATTRIBUTE; modifyDataType columnName=VALUE, tableName=CREDENTIAL; addForeignKeyConstraint baseTableName=FED_CREDENTIAL_ATTRIBU...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.3.0.xml::2.3.0::bburke@redhat.com
CREATE TABLE FEDERATED_USER
(
    ID                  varchar(255) NOT NULL,
    STORAGE_PROVIDER_ID varchar(255),
    REALM_ID            varchar(36)  NOT NULL
)
GO

ALTER TABLE FEDERATED_USER
    ADD CONSTRAINT CONSTR_FEDERATED_USER PRIMARY KEY (ID)
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE USER_ENTITY DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'USER_ENTITY')
  AND [c].[name] = N'TOTP'
EXEC sp_executesql @sql
GO

ALTER TABLE USER_ENTITY
    DROP COLUMN TOTP
GO

ALTER TABLE IDENTITY_PROVIDER
    ADD PROVIDER_DISPLAY_NAME varchar(255)
GO

ALTER TABLE COMPONENT
    ADD SUB_TYPE varchar(255)
GO

-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
ALTER TABLE REALM
    DROP COLUMN CODE_SECRET
GO

ALTER TABLE REALM
    DROP COLUMN PRIVATE_KEY
GO

ALTER TABLE REALM
    DROP COLUMN PUBLIC_KEY
GO

ALTER TABLE REALM
    DROP COLUMN CERTIFICATE
GO

ALTER TABLE USER_CONSENT
    ADD CREATED_DATE bigint
GO

ALTER TABLE USER_CONSENT
    ADD LAST_UPDATED_DATE bigint
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.3.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-2.3.0.xml', GETDATE(), 31,
        '8:ada8b4833b74a498f376d7136bc7d327',
        'createTable tableName=FEDERATED_USER; addPrimaryKey constraintName=CONSTR_FEDERATED_USER, tableName=FEDERATED_USER; dropDefaultValue columnName=TOTP, tableName=USER_ENTITY; dropColumn columnName=TOTP, tableName=USER_ENTITY; addColumn tableName=IDE...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.4.0.xml::2.4.0::bburke@redhat.com
-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.4.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-2.4.0.xml', GETDATE(), 32,
        '8:b9b73c8ea7299457f99fcbb825c263ba', 'customChange', '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.5.0.xml::2.5.0::bburke@redhat.com
-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
ALTER TABLE OFFLINE_USER_SESSION
    ALTER COLUMN USER_ID varchar(255)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.5.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-2.5.0.xml', GETDATE(), 33,
        '8:07724333e625ccfcfc5adc63d57314f3',
        'customChange; modifyDataType columnName=USER_ID, tableName=OFFLINE_USER_SESSION', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.5.0.xml::2.5.0-unicode-oracle::hmlnarik@redhat.com
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.5.0-unicode-oracle', 'hmlnarik@redhat.com', 'META-INF/jpa-changelog-2.5.0.xml', GETDATE(), 34,
        '8:8b6fd445958882efe55deb26fc541a7b',
        'modifyDataType columnName=DESCRIPTION, tableName=AUTHENTICATION_FLOW; modifyDataType columnName=DESCRIPTION, tableName=CLIENT_TEMPLATE; modifyDataType columnName=DESCRIPTION, tableName=RESOURCE_SERVER_POLICY; modifyDataType columnName=DESCRIPTION,...',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.5.0.xml::2.5.0-unicode-other-dbs::hmlnarik@redhat.com
ALTER TABLE AUTHENTICATION_FLOW
    ALTER COLUMN DESCRIPTION nvarchar(255)
GO

ALTER TABLE CLIENT_TEMPLATE
    ALTER COLUMN DESCRIPTION nvarchar(255)
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ALTER COLUMN DESCRIPTION nvarchar(255)
GO

ALTER TABLE CLIENT
    ALTER COLUMN DESCRIPTION nvarchar(255)
GO

ALTER TABLE CLIENT
    ALTER COLUMN NAME nvarchar(255)
GO

ALTER TABLE USER_ENTITY
    DROP CONSTRAINT UK_RU8TT6T700S9V50BU18WS5HA6
GO

ALTER TABLE USER_ENTITY
    ALTER COLUMN FIRST_NAME nvarchar(255)
GO

ALTER TABLE USER_ENTITY
    ALTER COLUMN LAST_NAME nvarchar(255)
GO

ALTER TABLE USER_ENTITY
    ALTER COLUMN USERNAME nvarchar(255)
GO

ALTER TABLE USER_ENTITY
    ADD CONSTRAINT UK_RU8TT6T700S9V50BU18WS5HA6 UNIQUE (REALM_ID, USERNAME)
GO

ALTER TABLE USERNAME_LOGIN_FAILURE
    DROP CONSTRAINT CONSTRAINT_17
GO

ALTER TABLE USERNAME_LOGIN_FAILURE
    ALTER COLUMN USERNAME nvarchar(255)
GO

ALTER TABLE USERNAME_LOGIN_FAILURE
    ALTER COLUMN USERNAME nvarchar(255) NOT NULL
GO

ALTER TABLE USERNAME_LOGIN_FAILURE
    ADD CONSTRAINT [CONSTRAINT_17-2] PRIMARY KEY (REALM_ID, USERNAME)
GO

ALTER TABLE KEYCLOAK_GROUP
    ALTER COLUMN NAME nvarchar(255)
GO

ALTER TABLE USER_ATTRIBUTE
    ALTER COLUMN VALUE nvarchar(255)
GO

ALTER TABLE GROUP_ATTRIBUTE
    ALTER COLUMN VALUE nvarchar(255)
GO

ALTER TABLE REALM_ATTRIBUTE
    ALTER COLUMN VALUE nvarchar(255)
GO

ALTER TABLE COMPONENT_CONFIG
    ALTER COLUMN VALUE nvarchar(4000)
GO

ALTER TABLE KEYCLOAK_ROLE
    DROP CONSTRAINT [UK_J3RWUVD56ONTGSUHOGM184WW2-2]
GO

ALTER TABLE KEYCLOAK_ROLE
    ALTER COLUMN NAME nvarchar(255)
GO

ALTER TABLE KEYCLOAK_ROLE
    ADD CONSTRAINT [UK_J3RWUVD56ONTGSUHOGM184WW2-2] UNIQUE (NAME, CLIENT_REALM_CONSTRAINT)
GO

ALTER TABLE KEYCLOAK_ROLE
    ALTER COLUMN DESCRIPTION nvarchar(255)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.5.0-unicode-other-dbs', 'hmlnarik@redhat.com', 'META-INF/jpa-changelog-2.5.0.xml', GETDATE(), 35,
        '8:29b29cfebfd12600897680147277a9d7',
        'modifyDataType columnName=DESCRIPTION, tableName=AUTHENTICATION_FLOW; modifyDataType columnName=DESCRIPTION, tableName=CLIENT_TEMPLATE; modifyDataType columnName=DESCRIPTION, tableName=RESOURCE_SERVER_POLICY; modifyDataType columnName=DESCRIPTION,...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.5.0.xml::2.5.0-duplicate-email-support::slawomir@dabek.name
ALTER TABLE REALM
    ADD LOGIN_WITH_EMAIL_ALLOWED bit
        CONSTRAINT DF_REALM_LOGIN_WITH_EMAIL_ALLOWED DEFAULT 1 NOT NULL
GO

ALTER TABLE REALM
    ADD DUPLICATE_EMAILS_ALLOWED bit
        CONSTRAINT DF_REALM_DUPLICATE_EMAILS_ALLOWED DEFAULT 0 NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.5.0-duplicate-email-support', 'slawomir@dabek.name', 'META-INF/jpa-changelog-2.5.0.xml', GETDATE(), 36,
        '8:73ad77ca8fd0410c7f9f15a471fa52bc', 'addColumn tableName=REALM', '', 'EXECUTED', NULL, NULL, '3.8.8',
        '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.5.0.xml::2.5.0-unique-group-names::hmlnarik@redhat.com
ALTER TABLE KEYCLOAK_GROUP
    ADD CONSTRAINT SIBLING_NAMES UNIQUE (REALM_ID, PARENT_GROUP, NAME)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.5.0-unique-group-names', 'hmlnarik@redhat.com', 'META-INF/jpa-changelog-2.5.0.xml', GETDATE(), 37,
        '8:64f27a6fdcad57f6f9153210f2ec1bdb',
        'addUniqueConstraint constraintName=SIBLING_NAMES, tableName=KEYCLOAK_GROUP', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-2.5.1.xml::2.5.1::bburke@redhat.com
ALTER TABLE FED_USER_CONSENT
    ADD CREATED_DATE bigint
GO

ALTER TABLE FED_USER_CONSENT
    ADD LAST_UPDATED_DATE bigint
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('2.5.1', 'bburke@redhat.com', 'META-INF/jpa-changelog-2.5.1.xml', GETDATE(), 38,
        '8:27180251182e6c31846c2ddab4bc5781', 'addColumn tableName=FED_USER_CONSENT', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.0.0.xml::3.0.0::bburke@redhat.com
ALTER TABLE IDENTITY_PROVIDER
    ADD LINK_ONLY bit
        CONSTRAINT DF_IDENTITY_PROVIDER_LINK_ONLY DEFAULT 0 NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.0.0', 'bburke@redhat.com', 'META-INF/jpa-changelog-3.0.0.xml', GETDATE(), 39,
        '8:d56f201bfcfa7a1413eb3e9bc02978f9', 'addColumn tableName=IDENTITY_PROVIDER', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.2.0.xml::3.2.0-fix::keycloak
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.2.0-fix', 'keycloak', 'META-INF/jpa-changelog-3.2.0.xml', GETDATE(), 40,
        '8:91f5522bf6afdc2077dfab57fbd3455c',
        'addNotNullConstraint columnName=REALM_ID, tableName=CLIENT_INITIAL_ACCESS', '', 'MARK_RAN', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.2.0.xml::3.2.0-fix-with-keycloak-5416::keycloak
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.2.0-fix-with-keycloak-5416', 'keycloak', 'META-INF/jpa-changelog-3.2.0.xml', GETDATE(), 41,
        '8:0f01b554f256c22caeb7d8aee3a1cdc8',
        'dropIndex indexName=IDX_CLIENT_INIT_ACC_REALM, tableName=CLIENT_INITIAL_ACCESS; addNotNullConstraint columnName=REALM_ID, tableName=CLIENT_INITIAL_ACCESS; createIndex indexName=IDX_CLIENT_INIT_ACC_REALM, tableName=CLIENT_INITIAL_ACCESS',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.2.0.xml::3.2.0-fix-offline-sessions::hmlnarik
-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.2.0-fix-offline-sessions', 'hmlnarik', 'META-INF/jpa-changelog-3.2.0.xml', GETDATE(), 42,
        '8:ab91cf9cee415867ade0e2df9651a947', 'customChange', '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.2.0.xml::3.2.0-fixed::keycloak
ALTER TABLE REALM
    ADD DOCKER_AUTH_FLOW varchar(36)
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    DROP CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK2
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    DROP COLUMN CLIENT_SESSION_ID
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ADD CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK3 PRIMARY KEY (USER_SESSION_ID, CLIENT_ID, OFFLINE_FLAG)
GO

CREATE TABLE CLIENT_INITIAL_ACCESS
(
    ID              varchar(36) NOT NULL,
    REALM_ID        varchar(36) NOT NULL,
    TIMESTAMP       int,
    EXPIRATION      int,
    COUNT           int,
    REMAINING_COUNT int
)
GO

ALTER TABLE CLIENT_INITIAL_ACCESS
    ADD CONSTRAINT CNSTR_CLIENT_INIT_ACC_PK PRIMARY KEY (ID)
GO

ALTER TABLE CLIENT_INITIAL_ACCESS
    ADD CONSTRAINT FK_CLIENT_INIT_ACC_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

CREATE NONCLUSTERED INDEX IDX_ASSOC_POL_ASSOC_POL_ID ON ASSOCIATED_POLICY (ASSOCIATED_POLICY_ID)
GO

CREATE NONCLUSTERED INDEX IDX_AUTH_EXEC_REALM_FLOW ON AUTHENTICATION_EXECUTION (REALM_ID, FLOW_ID)
GO

CREATE NONCLUSTERED INDEX IDX_AUTH_EXEC_FLOW ON AUTHENTICATION_EXECUTION (FLOW_ID)
GO

CREATE NONCLUSTERED INDEX IDX_AUTH_FLOW_REALM ON AUTHENTICATION_FLOW (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_AUTH_CONFIG_REALM ON AUTHENTICATOR_CONFIG (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLIENT_CLIENT_TEMPL_ID ON CLIENT (CLIENT_TEMPLATE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLIENT_DEF_ROLES_CLIENT ON CLIENT_DEFAULT_ROLES (CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLIENT_ID_PROV_MAP_CLIENT ON CLIENT_IDENTITY_PROV_MAPPING (CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLIENT_SESSION_SESSION ON CLIENT_SESSION (SESSION_ID)
GO

CREATE NONCLUSTERED INDEX IDX_COMPONENT_REALM ON COMPONENT (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_COMPO_CONFIG_COMPO ON COMPONENT_CONFIG (COMPONENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_COMPOSITE ON COMPOSITE_ROLE (COMPOSITE)
GO

CREATE NONCLUSTERED INDEX IDX_COMPOSITE_CHILD ON COMPOSITE_ROLE (CHILD_ROLE)
GO

CREATE NONCLUSTERED INDEX IDX_CREDENTIAL_ATTR_CRED ON CREDENTIAL_ATTRIBUTE (CREDENTIAL_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FED_CRED_ATTR_CRED ON FED_CREDENTIAL_ATTRIBUTE (CREDENTIAL_ID)
GO

CREATE NONCLUSTERED INDEX IDX_GROUP_ATTR_GROUP ON GROUP_ATTRIBUTE (GROUP_ID)
GO

CREATE NONCLUSTERED INDEX IDX_GROUP_ROLE_MAPP_GROUP ON GROUP_ROLE_MAPPING (GROUP_ID)
GO

CREATE NONCLUSTERED INDEX IDX_IDENT_PROV_REALM ON IDENTITY_PROVIDER (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_ID_PROV_MAPP_REALM ON IDENTITY_PROVIDER_MAPPER (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_KEYCLOAK_ROLE_CLIENT ON KEYCLOAK_ROLE (CLIENT)
GO

CREATE NONCLUSTERED INDEX IDX_KEYCLOAK_ROLE_REALM ON KEYCLOAK_ROLE (REALM)
GO

CREATE NONCLUSTERED INDEX IDX_PROTOCOL_MAPPER_CLIENT ON PROTOCOL_MAPPER (CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_PROTO_MAPP_CLIENT_TEMPL ON PROTOCOL_MAPPER (CLIENT_TEMPLATE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_MASTER_ADM_CLI ON REALM (MASTER_ADMIN_CLIENT)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_ATTR_REALM ON REALM_ATTRIBUTE (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_DEF_GRP_REALM ON REALM_DEFAULT_GROUPS (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_DEF_ROLES_REALM ON REALM_DEFAULT_ROLES (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_EVT_TYPES_REALM ON REALM_ENABLED_EVENT_TYPES (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_EVT_LIST_REALM ON REALM_EVENTS_LISTENERS (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_SUPP_LOCAL_REALM ON REALM_SUPPORTED_LOCALES (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REDIR_URI_CLIENT ON REDIRECT_URIS (CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REQ_ACT_PROV_REALM ON REQUIRED_ACTION_PROVIDER (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_POLICY_POLICY ON RESOURCE_POLICY (POLICY_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SCOPE_SCOPE ON RESOURCE_SCOPE (SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SERV_POL_RES_SERV ON RESOURCE_SERVER_POLICY (RESOURCE_SERVER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SRV_RES_RES_SRV ON RESOURCE_SERVER_RESOURCE (RESOURCE_SERVER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SRV_SCOPE_RES_SRV ON RESOURCE_SERVER_SCOPE (RESOURCE_SERVER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_SCOPE_MAPPING_ROLE ON SCOPE_MAPPING (ROLE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_SCOPE_POLICY_POLICY ON SCOPE_POLICY (POLICY_ID)
GO

CREATE NONCLUSTERED INDEX IDX_TEMPL_SCOPE_MAPP_ROLE ON TEMPLATE_SCOPE_MAPPING (ROLE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USR_FED_MAP_FED_PRV ON USER_FEDERATION_MAPPER (FEDERATION_PROVIDER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USR_FED_MAP_REALM ON USER_FEDERATION_MAPPER (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USR_FED_PRV_REALM ON USER_FEDERATION_PROVIDER (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_WEB_ORIG_CLIENT ON WEB_ORIGINS (CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLIENT_INIT_ACC_REALM ON CLIENT_INITIAL_ACCESS (REALM_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.2.0-fixed', 'keycloak', 'META-INF/jpa-changelog-3.2.0.xml', GETDATE(), 43,
        '8:ceac9b1889e97d602caf373eadb0d4b7',
        'addColumn tableName=REALM; dropPrimaryKey constraintName=CONSTRAINT_OFFL_CL_SES_PK2, tableName=OFFLINE_CLIENT_SESSION; dropColumn columnName=CLIENT_SESSION_ID, tableName=OFFLINE_CLIENT_SESSION; addPrimaryKey constraintName=CONSTRAINT_OFFL_CL_SES_P...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.3.0.xml::3.3.0::keycloak
ALTER TABLE USER_ENTITY
    ADD NOT_BEFORE int
        CONSTRAINT DF_USER_ENTITY_NOT_BEFORE DEFAULT 0 NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.3.0', 'keycloak', 'META-INF/jpa-changelog-3.3.0.xml', GETDATE(), 44, '8:84b986e628fe8f7fd8fd3c275c5259f2',
        'addColumn tableName=USER_ENTITY', '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-3.4.0.CR1.xml::authz-3.4.0.CR1-resource-server-pk-change-part1::glavoie@gmail.com
ALTER TABLE RESOURCE_SERVER_POLICY
    ADD RESOURCE_SERVER_CLIENT_ID varchar(36)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD RESOURCE_SERVER_CLIENT_ID varchar(36)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD RESOURCE_SERVER_CLIENT_ID varchar(36)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-3.4.0.CR1-resource-server-pk-change-part1', 'glavoie@gmail.com',
        'META-INF/jpa-changelog-authz-3.4.0.CR1.xml', GETDATE(), 45, '8:a164ae073c56ffdbc98a615493609a52',
        'addColumn tableName=RESOURCE_SERVER_POLICY; addColumn tableName=RESOURCE_SERVER_RESOURCE; addColumn tableName=RESOURCE_SERVER_SCOPE',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-3.4.0.CR1.xml::authz-3.4.0.CR1-resource-server-pk-change-part2-KEYCLOAK-6095::hmlnarik@redhat.com
-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-3.4.0.CR1-resource-server-pk-change-part2-KEYCLOAK-6095', 'hmlnarik@redhat.com',
        'META-INF/jpa-changelog-authz-3.4.0.CR1.xml', GETDATE(), 46, '8:70a2b4f1f4bd4dbf487114bdb1810e64',
        'customChange', '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-3.4.0.CR1.xml::authz-3.4.0.CR1-resource-server-pk-change-part3-fixed::glavoie@gmail.com
DROP INDEX IDX_RES_SERV_POL_RES_SERV ON RESOURCE_SERVER_POLICY
GO

DROP INDEX IDX_RES_SRV_RES_RES_SRV ON RESOURCE_SERVER_RESOURCE
GO

DROP INDEX IDX_RES_SRV_SCOPE_RES_SRV ON RESOURCE_SERVER_SCOPE
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-3.4.0.CR1-resource-server-pk-change-part3-fixed', 'glavoie@gmail.com',
        'META-INF/jpa-changelog-authz-3.4.0.CR1.xml', GETDATE(), 47, '8:7be68b71d2f5b94b8df2e824f2860fa2',
        'dropIndex indexName=IDX_RES_SERV_POL_RES_SERV, tableName=RESOURCE_SERVER_POLICY; dropIndex indexName=IDX_RES_SRV_RES_RES_SRV, tableName=RESOURCE_SERVER_RESOURCE; dropIndex indexName=IDX_RES_SRV_SCOPE_RES_SRV, tableName=RESOURCE_SERVER_SCOPE',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-3.4.0.CR1.xml::authz-3.4.0.CR1-resource-server-pk-change-part3-fixed-nodropindex::glavoie@gmail.com
ALTER TABLE RESOURCE_SERVER_POLICY
    ALTER COLUMN RESOURCE_SERVER_CLIENT_ID varchar(36) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ALTER COLUMN RESOURCE_SERVER_CLIENT_ID varchar(36) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ALTER COLUMN RESOURCE_SERVER_CLIENT_ID varchar(36) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    DROP CONSTRAINT UK_FRSRPT700S9V50BU18WS5HA6
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    DROP CONSTRAINT UK_FRSR6T700S9V50BU18WS5HA6
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    DROP CONSTRAINT UK_FRSRST700S9V50BU18WS5HA6
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    DROP CONSTRAINT FK_FRSRPO213XCX4WNKOG82SSRFY
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    DROP COLUMN RESOURCE_SERVER_ID
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    DROP CONSTRAINT FK_FRSRHO213XCX4WNKOG82SSRFY
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    DROP COLUMN RESOURCE_SERVER_ID
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    DROP CONSTRAINT FK_FRSRSO213XCX4WNKOG82SSRFY
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    DROP COLUMN RESOURCE_SERVER_ID
GO

ALTER TABLE RESOURCE_SERVER
    DROP CONSTRAINT CONSTRAINT_FARS
GO

ALTER TABLE RESOURCE_SERVER
    DROP CONSTRAINT UK_AU8TT6T700S9V50BU18WS5HA6
GO

ALTER TABLE RESOURCE_SERVER
    DROP COLUMN ID
GO

exec sp_rename 'RESOURCE_SERVER.CLIENT_ID', 'ID'
GO

exec sp_rename 'RESOURCE_SERVER_POLICY.RESOURCE_SERVER_CLIENT_ID', 'RESOURCE_SERVER_ID'
GO

exec sp_rename 'RESOURCE_SERVER_RESOURCE.RESOURCE_SERVER_CLIENT_ID', 'RESOURCE_SERVER_ID'
GO

exec sp_rename 'RESOURCE_SERVER_SCOPE.RESOURCE_SERVER_CLIENT_ID', 'RESOURCE_SERVER_ID'
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ADD CONSTRAINT UK_FRSRPT700S9V50BU18WS5HA6 UNIQUE (NAME, RESOURCE_SERVER_ID)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD CONSTRAINT UK_FRSR6T700S9V50BU18WS5HA6 UNIQUE (NAME, OWNER, RESOURCE_SERVER_ID)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD CONSTRAINT UK_FRSRST700S9V50BU18WS5HA6 UNIQUE (NAME, RESOURCE_SERVER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SERV_POL_RES_SERV ON RESOURCE_SERVER_POLICY (RESOURCE_SERVER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SRV_RES_RES_SRV ON RESOURCE_SERVER_RESOURCE (RESOURCE_SERVER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_RES_SRV_SCOPE_RES_SRV ON RESOURCE_SERVER_SCOPE (RESOURCE_SERVER_ID)
GO

ALTER TABLE RESOURCE_SERVER
    ADD CONSTRAINT PK_RESOURCE_SERVER PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ADD CONSTRAINT FK_FRSRPO213XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD CONSTRAINT FK_FRSRHO213XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD CONSTRAINT FK_FRSRSO213XCX4WNKOG82SSRFY FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-3.4.0.CR1-resource-server-pk-change-part3-fixed-nodropindex', 'glavoie@gmail.com',
        'META-INF/jpa-changelog-authz-3.4.0.CR1.xml', GETDATE(), 48, '8:bab7c631093c3861d6cf6144cd944982',
        'addNotNullConstraint columnName=RESOURCE_SERVER_CLIENT_ID, tableName=RESOURCE_SERVER_POLICY; addNotNullConstraint columnName=RESOURCE_SERVER_CLIENT_ID, tableName=RESOURCE_SERVER_RESOURCE; addNotNullConstraint columnName=RESOURCE_SERVER_CLIENT_ID, ...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-3.4.0.CR1.xml::authn-3.4.0.CR1-refresh-token-max-reuse::glavoie@gmail.com
ALTER TABLE REALM
    ADD REFRESH_TOKEN_MAX_REUSE int
        CONSTRAINT DF_REALM_REFRESH_TOKEN_MAX_REUSE DEFAULT 0
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authn-3.4.0.CR1-refresh-token-max-reuse', 'glavoie@gmail.com', 'META-INF/jpa-changelog-authz-3.4.0.CR1.xml',
        GETDATE(), 49, '8:fa809ac11877d74d76fe40869916daad', 'addColumn tableName=REALM', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.4.0.xml::3.4.0::keycloak
ALTER TABLE REALM_DEFAULT_ROLES
    ADD CONSTRAINT CONSTRAINT_REALM_DEFAULT_ROLES PRIMARY KEY (REALM_ID, ROLE_ID)
GO

ALTER TABLE COMPOSITE_ROLE
    ADD CONSTRAINT CONSTRAINT_COMPOSITE_ROLE PRIMARY KEY (COMPOSITE, CHILD_ROLE)
GO

ALTER TABLE REALM_DEFAULT_GROUPS
    ADD CONSTRAINT CONSTR_REALM_DEFAULT_GROUPS PRIMARY KEY (REALM_ID, GROUP_ID)
GO

ALTER TABLE CLIENT_IDENTITY_PROV_MAPPING
    ADD CONSTRAINT CONSTR_CLIENT_IDEN_PROV_MAP PRIMARY KEY (CLIENT_ID, IDENTITY_PROVIDER_ID)
GO

ALTER TABLE ADMIN_EVENT_ENTITY
    ADD CONSTRAINT CONSTRAINT_ADMIN_EVENT_ENTITY PRIMARY KEY (ID)
GO

ALTER TABLE CREDENTIAL_ATTRIBUTE
    ADD CONSTRAINT CONSTRAINT_CREDENTIAL_ATTR PRIMARY KEY (ID)
GO

ALTER TABLE FED_CREDENTIAL_ATTRIBUTE
    ADD CONSTRAINT CONSTRAINT_FED_CREDENTIAL_ATTR PRIMARY KEY (ID)
GO

ALTER TABLE CLIENT_DEFAULT_ROLES
    DROP CONSTRAINT FK_NUILTS7KLWQW2H8M2B5JOYTKY
GO

ALTER TABLE CLIENT_DEFAULT_ROLES
    ADD CONSTRAINT CONSTR_CLIENT_DEFAULT_ROLES PRIMARY KEY (CLIENT_ID, ROLE_ID)
GO

ALTER TABLE CLIENT_DEFAULT_ROLES
    ADD CONSTRAINT FK_NUILTS7KLWQW2H8M2B5JOYTKY FOREIGN KEY (CLIENT_ID) REFERENCES CLIENT (ID)
GO

ALTER TABLE REALM_ENABLED_EVENT_TYPES
    ALTER COLUMN VALUE varchar(255) NOT NULL
GO

ALTER TABLE REALM_ENABLED_EVENT_TYPES
    ADD CONSTRAINT CONSTR_REALM_ENABL_EVENT_TYPES PRIMARY KEY (REALM_ID, VALUE)
GO

ALTER TABLE REALM_EVENTS_LISTENERS
    ALTER COLUMN VALUE varchar(255) NOT NULL
GO

ALTER TABLE REALM_EVENTS_LISTENERS
    ADD CONSTRAINT CONSTR_REALM_EVENTS_LISTENERS PRIMARY KEY (REALM_ID, VALUE)
GO

ALTER TABLE REALM_SUPPORTED_LOCALES
    ALTER COLUMN VALUE varchar(255) NOT NULL
GO

ALTER TABLE REALM_SUPPORTED_LOCALES
    ADD CONSTRAINT CONSTR_REALM_SUPPORTED_LOCALES PRIMARY KEY (REALM_ID, VALUE)
GO

ALTER TABLE REDIRECT_URIS
    ALTER COLUMN VALUE varchar(255) NOT NULL
GO

ALTER TABLE REDIRECT_URIS
    ADD CONSTRAINT CONSTRAINT_REDIRECT_URIS PRIMARY KEY (CLIENT_ID, VALUE)
GO

ALTER TABLE WEB_ORIGINS
    ALTER COLUMN VALUE varchar(255) NOT NULL
GO

ALTER TABLE WEB_ORIGINS
    ADD CONSTRAINT CONSTRAINT_WEB_ORIGINS PRIMARY KEY (CLIENT_ID, VALUE)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.4.0', 'keycloak', 'META-INF/jpa-changelog-3.4.0.xml', GETDATE(), 50, '8:fac23540a40208f5f5e326f6ceb4d291',
        'addPrimaryKey constraintName=CONSTRAINT_REALM_DEFAULT_ROLES, tableName=REALM_DEFAULT_ROLES; addPrimaryKey constraintName=CONSTRAINT_COMPOSITE_ROLE, tableName=COMPOSITE_ROLE; addPrimaryKey constraintName=CONSTR_REALM_DEFAULT_GROUPS, tableName=REALM...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.4.0.xml::3.4.0-KEYCLOAK-5230::hmlnarik@redhat.com
CREATE NONCLUSTERED INDEX IDX_FU_ATTRIBUTE ON FED_USER_ATTRIBUTE (USER_ID, REALM_ID, NAME)
GO

CREATE NONCLUSTERED INDEX IDX_FU_CONSENT ON FED_USER_CONSENT (USER_ID, CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_CONSENT_RU ON FED_USER_CONSENT (REALM_ID, USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_CREDENTIAL ON FED_USER_CREDENTIAL (USER_ID, TYPE)
GO

CREATE NONCLUSTERED INDEX IDX_FU_CREDENTIAL_RU ON FED_USER_CREDENTIAL (REALM_ID, USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_GROUP_MEMBERSHIP ON FED_USER_GROUP_MEMBERSHIP (USER_ID, GROUP_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_GROUP_MEMBERSHIP_RU ON FED_USER_GROUP_MEMBERSHIP (REALM_ID, USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_REQUIRED_ACTION ON FED_USER_REQUIRED_ACTION (USER_ID, REQUIRED_ACTION)
GO

CREATE NONCLUSTERED INDEX IDX_FU_REQUIRED_ACTION_RU ON FED_USER_REQUIRED_ACTION (REALM_ID, USER_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_ROLE_MAPPING ON FED_USER_ROLE_MAPPING (USER_ID, ROLE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_FU_ROLE_MAPPING_RU ON FED_USER_ROLE_MAPPING (REALM_ID, USER_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.4.0-KEYCLOAK-5230', 'hmlnarik@redhat.com', 'META-INF/jpa-changelog-3.4.0.xml', GETDATE(), 51,
        '8:2612d1b8a97e2b5588c346e817307593',
        'createIndex indexName=IDX_FU_ATTRIBUTE, tableName=FED_USER_ATTRIBUTE; createIndex indexName=IDX_FU_CONSENT, tableName=FED_USER_CONSENT; createIndex indexName=IDX_FU_CONSENT_RU, tableName=FED_USER_CONSENT; createIndex indexName=IDX_FU_CREDENTIAL, t...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.4.1.xml::3.4.1::psilva@redhat.com
ALTER TABLE CLIENT_ATTRIBUTES
    ALTER COLUMN VALUE varchar(4000)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.4.1', 'psilva@redhat.com', 'META-INF/jpa-changelog-3.4.1.xml', GETDATE(), 52,
        '8:9842f155c5db2206c88bcb5d1046e941', 'modifyDataType columnName=VALUE, tableName=CLIENT_ATTRIBUTES', '',
        'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.4.2.xml::3.4.2::keycloak
UPDATE REALM
SET REFRESH_TOKEN_MAX_REUSE = 0
WHERE REFRESH_TOKEN_MAX_REUSE IS NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.4.2', 'keycloak', 'META-INF/jpa-changelog-3.4.2.xml', GETDATE(), 53, '8:2e12e06e45498406db72d5b3da5bbc76',
        'update tableName=REALM', '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-3.4.2.xml::3.4.2-KEYCLOAK-5172::mkanis@redhat.com
UPDATE CLIENT
SET PROTOCOL = 'openid-connect'
WHERE PROTOCOL IS NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('3.4.2-KEYCLOAK-5172', 'mkanis@redhat.com', 'META-INF/jpa-changelog-3.4.2.xml', GETDATE(), 54,
        '8:33560e7c7989250c40da3abdabdc75a4', 'update tableName=CLIENT', '', 'EXECUTED', NULL, NULL, '3.8.8',
        '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.0.0.xml::4.0.0-KEYCLOAK-6335::bburke@redhat.com
CREATE TABLE CLIENT_AUTH_FLOW_BINDINGS
(
    CLIENT_ID    varchar(36)  NOT NULL,
    FLOW_ID      varchar(36),
    BINDING_NAME varchar(255) NOT NULL
)
GO

ALTER TABLE CLIENT_AUTH_FLOW_BINDINGS
    ADD CONSTRAINT C_CLI_FLOW_BIND PRIMARY KEY (CLIENT_ID, BINDING_NAME)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.0.0-KEYCLOAK-6335', 'bburke@redhat.com', 'META-INF/jpa-changelog-4.0.0.xml', GETDATE(), 55,
        '8:87a8d8542046817a9107c7eb9cbad1cd',
        'createTable tableName=CLIENT_AUTH_FLOW_BINDINGS; addPrimaryKey constraintName=C_CLI_FLOW_BIND, tableName=CLIENT_AUTH_FLOW_BINDINGS',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.0.0.xml::4.0.0-CLEANUP-UNUSED-TABLE::bburke@redhat.com
DROP TABLE CLIENT_IDENTITY_PROV_MAPPING
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.0.0-CLEANUP-UNUSED-TABLE', 'bburke@redhat.com', 'META-INF/jpa-changelog-4.0.0.xml', GETDATE(), 56,
        '8:3ea08490a70215ed0088c273d776311e', 'dropTable tableName=CLIENT_IDENTITY_PROV_MAPPING', '', 'EXECUTED', NULL,
        NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.0.0.xml::4.0.0-KEYCLOAK-6228::bburke@redhat.com
ALTER TABLE USER_CONSENT
    DROP CONSTRAINT UK_JKUWUVD56ONTGSUHOGM8UEWRT
GO

ALTER TABLE USER_CONSENT
    ALTER COLUMN CLIENT_ID varchar(36) NULL
GO

ALTER TABLE USER_CONSENT
    ADD CLIENT_STORAGE_PROVIDER varchar(36)
GO

ALTER TABLE USER_CONSENT
    ADD EXTERNAL_CLIENT_ID varchar(255)
GO

ALTER TABLE USER_CONSENT
    ADD CONSTRAINT UK_JKUWUVD56ONTGSUHOGM8UEWRT UNIQUE (CLIENT_ID, CLIENT_STORAGE_PROVIDER, EXTERNAL_CLIENT_ID, USER_ID)
GO

ALTER TABLE FED_USER_CONSENT
    ADD CLIENT_STORAGE_PROVIDER varchar(36)
GO

ALTER TABLE FED_USER_CONSENT
    ADD EXTERNAL_CLIENT_ID varchar(255)
GO

ALTER TABLE FED_USER_CONSENT
    ALTER COLUMN CLIENT_ID varchar(36) NULL
GO

CREATE NONCLUSTERED INDEX IDX_FU_CNSNT_EXT ON FED_USER_CONSENT (USER_ID, CLIENT_STORAGE_PROVIDER, EXTERNAL_CLIENT_ID)
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ADD CLIENT_STORAGE_PROVIDER varchar(36)
        CONSTRAINT DF_OFFLINE_CLIENT_SESSION_CLIENT_STORAGE_PROVIDER DEFAULT 'local' NOT NULL
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ADD EXTERNAL_CLIENT_ID varchar(255)
        CONSTRAINT DF_OFFLINE_CLIENT_SESSION_EXTERNAL_CLIENT_ID DEFAULT 'local' NOT NULL
GO

UPDATE OFFLINE_CLIENT_SESSION
SET CLIENT_STORAGE_PROVIDER = 'local'
GO

UPDATE OFFLINE_CLIENT_SESSION
SET EXTERNAL_CLIENT_ID = 'local'
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    DROP CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK3
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ADD CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK3 PRIMARY KEY (USER_SESSION_ID, CLIENT_ID, CLIENT_STORAGE_PROVIDER,
                                                           EXTERNAL_CLIENT_ID, OFFLINE_FLAG)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.0.0-KEYCLOAK-6228', 'bburke@redhat.com', 'META-INF/jpa-changelog-4.0.0.xml', GETDATE(), 57,
        '8:2d56697c8723d4592ab608ce14b6ed68',
        'dropUniqueConstraint constraintName=UK_JKUWUVD56ONTGSUHOGM8UEWRT, tableName=USER_CONSENT; dropNotNullConstraint columnName=CLIENT_ID, tableName=USER_CONSENT; addColumn tableName=USER_CONSENT; addUniqueConstraint constraintName=UK_JKUWUVD56ONTGSUHO...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.0.0.xml::4.0.0-KEYCLOAK-5579-fixed::mposolda@redhat.com
ALTER TABLE CLIENT_TEMPLATE_ATTRIBUTES
    DROP CONSTRAINT FK_CL_TEMPL_ATTR_TEMPL
GO

exec sp_rename 'CLIENT_TEMPLATE_ATTRIBUTES', 'CLIENT_SCOPE_ATTRIBUTES'
GO

exec sp_rename 'CLIENT_SCOPE_ATTRIBUTES.TEMPLATE_ID', 'SCOPE_ID'
GO

ALTER TABLE TEMPLATE_SCOPE_MAPPING
    DROP CONSTRAINT FK_TEMPL_SCOPE_TEMPL
GO

ALTER TABLE TEMPLATE_SCOPE_MAPPING
    DROP CONSTRAINT FK_TEMPL_SCOPE_ROLE
GO

exec sp_rename 'TEMPLATE_SCOPE_MAPPING', 'CLIENT_SCOPE_ROLE_MAPPING'
GO

exec sp_rename 'CLIENT_SCOPE_ROLE_MAPPING.TEMPLATE_ID', 'SCOPE_ID'
GO

ALTER TABLE CLIENT
    DROP CONSTRAINT FK_CLI_TMPLT_CLIENT
GO

ALTER TABLE PROTOCOL_MAPPER
    DROP CONSTRAINT FK_CLI_TMPLT_MAPPER
GO

exec sp_rename 'PROTOCOL_MAPPER.CLIENT_TEMPLATE_ID', 'CLIENT_SCOPE_ID'
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP CONSTRAINT FK_REALM_CLI_TMPLT
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP CONSTRAINT UK_CLI_TEMPLATE
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'FULL_SCOPE_ALLOWED'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'CONSENT_REQUIRED'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'STANDARD_FLOW_ENABLED'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'IMPLICIT_FLOW_ENABLED'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'DIRECT_ACCESS_GRANTS_ENABLED'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'SERVICE_ACCOUNTS_ENABLED'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'FRONTCHANNEL_LOGOUT'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'BEARER_ONLY'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT_TEMPLATE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT_TEMPLATE')
  AND [c].[name] = N'PUBLIC_CLIENT'
EXEC sp_executesql @sql
GO

DROP INDEX IDX_TEMPL_SCOPE_MAPP_ROLE ON CLIENT_SCOPE_ROLE_MAPPING
GO

DROP INDEX IDX_PROTO_MAPP_CLIENT_TEMPL ON PROTOCOL_MAPPER
GO

DROP INDEX IDX_CLIENT_CLIENT_TEMPL_ID ON CLIENT
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN FULL_SCOPE_ALLOWED
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN CONSENT_REQUIRED
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN STANDARD_FLOW_ENABLED
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN IMPLICIT_FLOW_ENABLED
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN DIRECT_ACCESS_GRANTS_ENABLED
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN SERVICE_ACCOUNTS_ENABLED
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN FRONTCHANNEL_LOGOUT
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN BEARER_ONLY
GO

ALTER TABLE CLIENT_TEMPLATE
    DROP COLUMN PUBLIC_CLIENT
GO

exec sp_rename 'CLIENT_TEMPLATE', 'CLIENT_SCOPE'
GO

ALTER TABLE CLIENT_SCOPE
    ADD CONSTRAINT UK_CLI_SCOPE UNIQUE (REALM_ID, NAME)
GO

ALTER TABLE CLIENT_SCOPE
    ADD CONSTRAINT FK_REALM_CLI_SCOPE FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE PROTOCOL_MAPPER
    ADD CONSTRAINT FK_CLI_SCOPE_MAPPER FOREIGN KEY (CLIENT_SCOPE_ID) REFERENCES CLIENT_SCOPE (ID)
GO

ALTER TABLE CLIENT_SCOPE_ROLE_MAPPING
    ADD CONSTRAINT FK_CL_SCOPE_RM_SCOPE FOREIGN KEY (SCOPE_ID) REFERENCES CLIENT_SCOPE (ID)
GO

ALTER TABLE CLIENT_SCOPE_ROLE_MAPPING
    ADD CONSTRAINT FK_CL_SCOPE_RM_ROLE FOREIGN KEY (ROLE_ID) REFERENCES KEYCLOAK_ROLE (ID)
GO

ALTER TABLE CLIENT_SCOPE_ATTRIBUTES
    ADD CONSTRAINT FK_CL_SCOPE_ATTR_SCOPE FOREIGN KEY (SCOPE_ID) REFERENCES CLIENT_SCOPE (ID)
GO

CREATE TABLE CLIENT_SCOPE_CLIENT
(
    CLIENT_ID     varchar(36)                                     NOT NULL,
    SCOPE_ID      varchar(36)                                     NOT NULL,
    DEFAULT_SCOPE bit
        CONSTRAINT DF_CLIENT_SCOPE_CLIENT_DEFAULT_SCOPE DEFAULT 0 NOT NULL
)
GO

ALTER TABLE CLIENT_SCOPE_CLIENT
    ADD CONSTRAINT C_CLI_SCOPE_BIND PRIMARY KEY (CLIENT_ID, SCOPE_ID)
GO

ALTER TABLE CLIENT_SCOPE_CLIENT
    ADD CONSTRAINT FK_C_CLI_SCOPE_CLIENT FOREIGN KEY (CLIENT_ID) REFERENCES CLIENT (ID)
GO

ALTER TABLE CLIENT_SCOPE_CLIENT
    ADD CONSTRAINT FK_C_CLI_SCOPE_SCOPE FOREIGN KEY (SCOPE_ID) REFERENCES CLIENT_SCOPE (ID)
GO

-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
ALTER TABLE CLIENT
    DROP COLUMN CLIENT_TEMPLATE_ID
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT')
  AND [c].[name] = N'USE_TEMPLATE_CONFIG'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT')
  AND [c].[name] = N'USE_TEMPLATE_SCOPE'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CLIENT DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CLIENT')
  AND [c].[name] = N'USE_TEMPLATE_MAPPERS'
EXEC sp_executesql @sql
GO

ALTER TABLE CLIENT
    DROP COLUMN USE_TEMPLATE_CONFIG
GO

ALTER TABLE CLIENT
    DROP COLUMN USE_TEMPLATE_SCOPE
GO

ALTER TABLE CLIENT
    DROP COLUMN USE_TEMPLATE_MAPPERS
GO

CREATE TABLE DEFAULT_CLIENT_SCOPE
(
    REALM_ID      varchar(36)                                      NOT NULL,
    SCOPE_ID      varchar(36)                                      NOT NULL,
    DEFAULT_SCOPE bit
        CONSTRAINT DF_DEFAULT_CLIENT_SCOPE_DEFAULT_SCOPE DEFAULT 0 NOT NULL
)
GO

ALTER TABLE DEFAULT_CLIENT_SCOPE
    ADD CONSTRAINT R_DEF_CLI_SCOPE_BIND PRIMARY KEY (REALM_ID, SCOPE_ID)
GO

ALTER TABLE DEFAULT_CLIENT_SCOPE
    ADD CONSTRAINT FK_R_DEF_CLI_SCOPE_REALM FOREIGN KEY (REALM_ID) REFERENCES REALM (ID)
GO

ALTER TABLE DEFAULT_CLIENT_SCOPE
    ADD CONSTRAINT FK_R_DEF_CLI_SCOPE_SCOPE FOREIGN KEY (SCOPE_ID) REFERENCES CLIENT_SCOPE (ID)
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE KEYCLOAK_ROLE DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'KEYCLOAK_ROLE')
  AND [c].[name] = N'SCOPE_PARAM_REQUIRED'
EXEC sp_executesql @sql
GO

ALTER TABLE KEYCLOAK_ROLE
    DROP COLUMN SCOPE_PARAM_REQUIRED
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE PROTOCOL_MAPPER DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'PROTOCOL_MAPPER')
  AND [c].[name] = N'CONSENT_REQUIRED'
EXEC sp_executesql @sql
GO

ALTER TABLE PROTOCOL_MAPPER
    DROP COLUMN CONSENT_REQUIRED
GO

ALTER TABLE PROTOCOL_MAPPER
    DROP COLUMN CONSENT_TEXT
GO

ALTER TABLE USER_CONSENT_ROLE
    DROP CONSTRAINT FK_GRNTCSNT_ROLE_GR
GO

DROP TABLE USER_CONSENT_ROLE
GO

ALTER TABLE USER_CONSENT_PROT_MAPPER
    DROP CONSTRAINT FK_GRNTCSNT_PRM_GR
GO

DROP TABLE USER_CONSENT_PROT_MAPPER
GO

CREATE TABLE USER_CONSENT_CLIENT_SCOPE
(
    USER_CONSENT_ID varchar(36) NOT NULL,
    SCOPE_ID        varchar(36) NOT NULL
)
GO

ALTER TABLE USER_CONSENT_CLIENT_SCOPE
    ADD CONSTRAINT CONSTRAINT_GRNTCSNT_CLSC_PM PRIMARY KEY (USER_CONSENT_ID, SCOPE_ID)
GO

ALTER TABLE USER_CONSENT_CLIENT_SCOPE
    ADD CONSTRAINT FK_GRNTCSNT_CLSC_USC FOREIGN KEY (USER_CONSENT_ID) REFERENCES USER_CONSENT (ID)
GO

DROP TABLE FED_USER_CONSENT_ROLE
GO

DROP TABLE FED_USER_CONSENT_PROT_MAPPER
GO

CREATE TABLE FED_USER_CONSENT_CL_SCOPE
(
    USER_CONSENT_ID varchar(36) NOT NULL,
    SCOPE_ID        varchar(36) NOT NULL
)
GO

ALTER TABLE FED_USER_CONSENT_CL_SCOPE
    ADD CONSTRAINT CONSTRAINT_FGRNTCSNT_CLSC_PM PRIMARY KEY (USER_CONSENT_ID, SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_REALM_CLSCOPE ON CLIENT_SCOPE (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLSCOPE_PROTMAP ON PROTOCOL_MAPPER (CLIENT_SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLSCOPE_ROLE ON CLIENT_SCOPE_ROLE_MAPPING (SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_ROLE_CLSCOPE ON CLIENT_SCOPE_ROLE_MAPPING (ROLE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLSCOPE_ATTRS ON CLIENT_SCOPE_ATTRIBUTES (SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CLSCOPE_CL ON CLIENT_SCOPE_CLIENT (CLIENT_ID)
GO

CREATE NONCLUSTERED INDEX IDX_CL_CLSCOPE ON CLIENT_SCOPE_CLIENT (SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_DEFCLS_REALM ON DEFAULT_CLIENT_SCOPE (REALM_ID)
GO

CREATE NONCLUSTERED INDEX IDX_DEFCLS_SCOPE ON DEFAULT_CLIENT_SCOPE (SCOPE_ID)
GO

CREATE NONCLUSTERED INDEX IDX_USCONSENT_CLSCOPE ON USER_CONSENT_CLIENT_SCOPE (USER_CONSENT_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.0.0-KEYCLOAK-5579-fixed', 'mposolda@redhat.com', 'META-INF/jpa-changelog-4.0.0.xml', GETDATE(), 58,
        '8:3e423e249f6068ea2bbe48bf907f9d86',
        'dropForeignKeyConstraint baseTableName=CLIENT_TEMPLATE_ATTRIBUTES, constraintName=FK_CL_TEMPL_ATTR_TEMPL; renameTable newTableName=CLIENT_SCOPE_ATTRIBUTES, oldTableName=CLIENT_TEMPLATE_ATTRIBUTES; renameColumn newColumnName=SCOPE_ID, oldColumnName...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-4.0.0.CR1.xml::authz-4.0.0.CR1::psilva@redhat.com
CREATE TABLE RESOURCE_SERVER_PERM_TICKET
(
    ID                 varchar(36) NOT NULL,
    OWNER              varchar(36) NOT NULL,
    REQUESTER          varchar(36) NOT NULL,
    CREATED_TIMESTAMP  bigint      NOT NULL,
    GRANTED_TIMESTAMP  bigint,
    RESOURCE_ID        varchar(36) NOT NULL,
    SCOPE_ID           varchar(36),
    RESOURCE_SERVER_ID varchar(36) NOT NULL
)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT CONSTRAINT_FAPMT PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT FK_FRSRHO213XCX4WNKOG82SSPMT FOREIGN KEY (RESOURCE_SERVER_ID) REFERENCES RESOURCE_SERVER (ID)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT FK_FRSRHO213XCX4WNKOG83SSPMT FOREIGN KEY (RESOURCE_ID) REFERENCES RESOURCE_SERVER_RESOURCE (ID)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT FK_FRSRHO213XCX4WNKOG84SSPMT FOREIGN KEY (SCOPE_ID) REFERENCES RESOURCE_SERVER_SCOPE (ID)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT UK_FRSR6T700S9V50BU18WS5PMT UNIQUE (OWNER, REQUESTER, RESOURCE_SERVER_ID, RESOURCE_ID, SCOPE_ID)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD OWNER_MANAGED_ACCESS bit
        CONSTRAINT DF_RESOURCE_SERVER_RESOURCE_OWNER_MANAGED_ACCESS DEFAULT 0 NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD DISPLAY_NAME varchar(255)
GO

ALTER TABLE RESOURCE_SERVER_SCOPE
    ADD DISPLAY_NAME varchar(255)
GO

ALTER TABLE REALM
    ADD ALLOW_USER_MANAGED_ACCESS bit
        CONSTRAINT DF_REALM_ALLOW_USER_MANAGED_ACCESS DEFAULT 0 NOT NULL
GO

CREATE TABLE RESOURCE_ATTRIBUTE
(
    ID          varchar(36)
        CONSTRAINT DF_RESOURCE_ATTRIBUTE_ID DEFAULT 'sybase-needs-something-here' NOT NULL,
    NAME        varchar(255)                                                      NOT NULL,
    VALUE       varchar(255),
    RESOURCE_ID varchar(36)                                                       NOT NULL
)
GO

ALTER TABLE RESOURCE_ATTRIBUTE
    ADD CONSTRAINT RES_ATTR_PK PRIMARY KEY (ID)
GO

ALTER TABLE RESOURCE_ATTRIBUTE
    ADD CONSTRAINT FK_5HRM2VLF9QL5FU022KQEPOVBR FOREIGN KEY (RESOURCE_ID) REFERENCES RESOURCE_SERVER_RESOURCE (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-4.0.0.CR1', 'psilva@redhat.com', 'META-INF/jpa-changelog-authz-4.0.0.CR1.xml', GETDATE(), 59,
        '8:15cabee5e5df0ff099510a0fc03e4103',
        'createTable tableName=RESOURCE_SERVER_PERM_TICKET; addPrimaryKey constraintName=CONSTRAINT_FAPMT, tableName=RESOURCE_SERVER_PERM_TICKET; addForeignKeyConstraint baseTableName=RESOURCE_SERVER_PERM_TICKET, constraintName=FK_FRSRHO213XCX4WNKOG82SSPMT...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-4.0.0.Beta3.xml::authz-4.0.0.Beta3::psilva@redhat.com
ALTER TABLE RESOURCE_SERVER_POLICY
    ADD OWNER varchar(36)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD POLICY_ID varchar(36)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT FK_FRSRPO2128CX4WNKOG82SSRFY FOREIGN KEY (POLICY_ID) REFERENCES RESOURCE_SERVER_POLICY (ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-4.0.0.Beta3', 'psilva@redhat.com', 'META-INF/jpa-changelog-authz-4.0.0.Beta3.xml', GETDATE(), 60,
        '8:4b80200af916ac54d2ffbfc47918ab0e',
        'addColumn tableName=RESOURCE_SERVER_POLICY; addColumn tableName=RESOURCE_SERVER_PERM_TICKET; addForeignKeyConstraint baseTableName=RESOURCE_SERVER_PERM_TICKET, constraintName=FK_FRSRPO2128CX4WNKOG82SSRFY, referencedTableName=RESOURCE_SERVER_POLICY',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-4.2.0.Final.xml::authz-4.2.0.Final::mhajas@redhat.com
CREATE TABLE RESOURCE_URIS
(
    RESOURCE_ID varchar(36)  NOT NULL,
    VALUE       varchar(255) NOT NULL
)
GO

ALTER TABLE RESOURCE_URIS
    ADD CONSTRAINT FK_RESOURCE_SERVER_URIS FOREIGN KEY (RESOURCE_ID) REFERENCES RESOURCE_SERVER_RESOURCE (ID)
GO

-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
ALTER TABLE RESOURCE_SERVER_RESOURCE
    DROP COLUMN URI
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-4.2.0.Final', 'mhajas@redhat.com', 'META-INF/jpa-changelog-authz-4.2.0.Final.xml', GETDATE(), 61,
        '8:66564cd5e168045d52252c5027485bbb',
        'createTable tableName=RESOURCE_URIS; addForeignKeyConstraint baseTableName=RESOURCE_URIS, constraintName=FK_RESOURCE_SERVER_URIS, referencedTableName=RESOURCE_SERVER_RESOURCE; customChange; dropColumn columnName=URI, tableName=RESOURCE_SERVER_RESO...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-4.2.0.Final.xml::authz-4.2.0.Final-KEYCLOAK-9944::hmlnarik@redhat.com
ALTER TABLE RESOURCE_URIS
    ADD CONSTRAINT CONSTRAINT_RESOUR_URIS_PK PRIMARY KEY (RESOURCE_ID, VALUE)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-4.2.0.Final-KEYCLOAK-9944', 'hmlnarik@redhat.com', 'META-INF/jpa-changelog-authz-4.2.0.Final.xml',
        GETDATE(), 62, '8:1c7064fafb030222be2bd16ccf690f6f',
        'addPrimaryKey constraintName=CONSTRAINT_RESOUR_URIS_PK, tableName=RESOURCE_URIS', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.2.0.xml::4.2.0-KEYCLOAK-6313::wadahiro@gmail.com
ALTER TABLE REQUIRED_ACTION_PROVIDER
    ADD PRIORITY int
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.2.0-KEYCLOAK-6313', 'wadahiro@gmail.com', 'META-INF/jpa-changelog-4.2.0.xml', GETDATE(), 63,
        '8:2de18a0dce10cdda5c7e65c9b719b6e5', 'addColumn tableName=REQUIRED_ACTION_PROVIDER', '', 'EXECUTED', NULL,
        NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.3.0.xml::4.3.0-KEYCLOAK-7984::wadahiro@gmail.com
UPDATE REQUIRED_ACTION_PROVIDER
SET PRIORITY = 0
WHERE PRIORITY is NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.3.0-KEYCLOAK-7984', 'wadahiro@gmail.com', 'META-INF/jpa-changelog-4.3.0.xml', GETDATE(), 64,
        '8:03e413dd182dcbd5c57e41c34d0ef682', 'update tableName=REQUIRED_ACTION_PROVIDER', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.6.0.xml::4.6.0-KEYCLOAK-7950::psilva@redhat.com
UPDATE RESOURCE_SERVER_RESOURCE
SET TYPE = 'Group'
WHERE NAME LIKE 'group.resource.%'
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.6.0-KEYCLOAK-7950', 'psilva@redhat.com', 'META-INF/jpa-changelog-4.6.0.xml', GETDATE(), 65,
        '8:d27b42bb2571c18fbe3fe4e4fb7582a7', 'update tableName=RESOURCE_SERVER_RESOURCE', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.6.0.xml::4.6.0-KEYCLOAK-8377::keycloak
CREATE TABLE ROLE_ATTRIBUTE
(
    ID      varchar(36)  NOT NULL,
    ROLE_ID varchar(36)  NOT NULL,
    NAME    varchar(255) NOT NULL,
    VALUE   nvarchar(255)
)
GO

ALTER TABLE ROLE_ATTRIBUTE
    ADD CONSTRAINT CONSTRAINT_ROLE_ATTRIBUTE_PK PRIMARY KEY (ID)
GO

ALTER TABLE ROLE_ATTRIBUTE
    ADD CONSTRAINT FK_ROLE_ATTRIBUTE_ID FOREIGN KEY (ROLE_ID) REFERENCES KEYCLOAK_ROLE (ID)
GO

CREATE NONCLUSTERED INDEX IDX_ROLE_ATTRIBUTE ON ROLE_ATTRIBUTE (ROLE_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.6.0-KEYCLOAK-8377', 'keycloak', 'META-INF/jpa-changelog-4.6.0.xml', GETDATE(), 66,
        '8:698baf84d9fd0027e9192717c2154fb8',
        'createTable tableName=ROLE_ATTRIBUTE; addPrimaryKey constraintName=CONSTRAINT_ROLE_ATTRIBUTE_PK, tableName=ROLE_ATTRIBUTE; addForeignKeyConstraint baseTableName=ROLE_ATTRIBUTE, constraintName=FK_ROLE_ATTRIBUTE_ID, referencedTableName=KEYCLOAK_ROLE...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.6.0.xml::4.6.0-KEYCLOAK-8555::gideonray@gmail.com
CREATE NONCLUSTERED INDEX IDX_COMPONENT_PROVIDER_TYPE ON COMPONENT (PROVIDER_TYPE)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.6.0-KEYCLOAK-8555', 'gideonray@gmail.com', 'META-INF/jpa-changelog-4.6.0.xml', GETDATE(), 67,
        '8:ced8822edf0f75ef26eb51582f9a821a', 'createIndex indexName=IDX_COMPONENT_PROVIDER_TYPE, tableName=COMPONENT',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.7.0.xml::4.7.0-KEYCLOAK-1267::sguilhen@redhat.com
ALTER TABLE REALM
    ADD SSO_MAX_LIFESPAN_REMEMBER_ME int
        CONSTRAINT DF_REALM_SSO_MAX_LIFESPAN_REMEMBER_ME DEFAULT 0
GO

ALTER TABLE REALM
    ADD SSO_IDLE_TIMEOUT_REMEMBER_ME int
        CONSTRAINT DF_REALM_SSO_IDLE_TIMEOUT_REMEMBER_ME DEFAULT 0
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.7.0-KEYCLOAK-1267', 'sguilhen@redhat.com', 'META-INF/jpa-changelog-4.7.0.xml', GETDATE(), 68,
        '8:f0abba004cf429e8afc43056df06487d', 'addColumn tableName=REALM', '', 'EXECUTED', NULL, NULL, '3.8.8',
        '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.7.0.xml::4.7.0-KEYCLOAK-7275::keycloak
exec sp_rename 'OFFLINE_USER_SESSION.LAST_SESSION_REFRESH', 'CREATED_ON'
GO

UPDATE OFFLINE_USER_SESSION
SET CREATED_ON = '0'
WHERE CREATED_ON IS NULL
GO

ALTER TABLE OFFLINE_USER_SESSION
    ALTER COLUMN CREATED_ON int NOT NULL
GO

ALTER TABLE OFFLINE_USER_SESSION
    ADD LAST_SESSION_REFRESH int
        CONSTRAINT DF_OFFLINE_USER_SESSION_LAST_SESSION_REFRESH DEFAULT 0 NOT NULL
GO

-- WARNING The following SQL may change each run and therefore is possibly incorrect and/or invalid:
CREATE NONCLUSTERED INDEX IDX_OFFLINE_USS_CREATEDON ON OFFLINE_USER_SESSION (CREATED_ON)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.7.0-KEYCLOAK-7275', 'keycloak', 'META-INF/jpa-changelog-4.7.0.xml', GETDATE(), 69,
        '8:6662f8b0b611caa359fcf13bf63b4e24',
        'renameColumn newColumnName=CREATED_ON, oldColumnName=LAST_SESSION_REFRESH, tableName=OFFLINE_USER_SESSION; addNotNullConstraint columnName=CREATED_ON, tableName=OFFLINE_USER_SESSION; addColumn tableName=OFFLINE_USER_SESSION; customChange; createIn...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-4.8.0.xml::4.8.0-KEYCLOAK-8835::sguilhen@redhat.com
UPDATE REALM
SET SSO_MAX_LIFESPAN_REMEMBER_ME = '0'
WHERE SSO_MAX_LIFESPAN_REMEMBER_ME IS NULL
GO

ALTER TABLE REALM
    ALTER COLUMN SSO_MAX_LIFESPAN_REMEMBER_ME int NOT NULL
GO

UPDATE REALM
SET SSO_IDLE_TIMEOUT_REMEMBER_ME = '0'
WHERE SSO_IDLE_TIMEOUT_REMEMBER_ME IS NULL
GO

ALTER TABLE REALM
    ALTER COLUMN SSO_IDLE_TIMEOUT_REMEMBER_ME int NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('4.8.0-KEYCLOAK-8835', 'sguilhen@redhat.com', 'META-INF/jpa-changelog-4.8.0.xml', GETDATE(), 70,
        '8:9e6b8009560f684250bdbdf97670d39e',
        'addNotNullConstraint columnName=SSO_MAX_LIFESPAN_REMEMBER_ME, tableName=REALM; addNotNullConstraint columnName=SSO_IDLE_TIMEOUT_REMEMBER_ME, tableName=REALM',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-authz-7.0.0.xml::authz-7.0.0-KEYCLOAK-10443::psilva@redhat.com
ALTER TABLE RESOURCE_SERVER
    ADD DECISION_STRATEGY tinyint
        CONSTRAINT DF_RESOURCE_SERVER_DECISION_STRATEGY DEFAULT 1 NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('authz-7.0.0-KEYCLOAK-10443', 'psilva@redhat.com', 'META-INF/jpa-changelog-authz-7.0.0.xml', GETDATE(), 71,
        '8:4223f561f3b8dc655846562b57bb502e', 'addColumn tableName=RESOURCE_SERVER', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-8.0.0.xml::8.0.0-adding-credential-columns::keycloak
ALTER TABLE CREDENTIAL
    ADD USER_LABEL varchar(255)
GO

ALTER TABLE CREDENTIAL
    ADD SECRET_DATA varchar(MAX)
GO

ALTER TABLE CREDENTIAL
    ADD CREDENTIAL_DATA varchar(MAX)
GO

ALTER TABLE CREDENTIAL
    ADD PRIORITY int
GO

ALTER TABLE FED_USER_CREDENTIAL
    ADD USER_LABEL varchar(255)
GO

ALTER TABLE FED_USER_CREDENTIAL
    ADD SECRET_DATA varchar(MAX)
GO

ALTER TABLE FED_USER_CREDENTIAL
    ADD CREDENTIAL_DATA varchar(MAX)
GO

ALTER TABLE FED_USER_CREDENTIAL
    ADD PRIORITY int
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('8.0.0-adding-credential-columns', 'keycloak', 'META-INF/jpa-changelog-8.0.0.xml', GETDATE(), 72,
        '8:215a31c398b363ce383a2b301202f29e', 'addColumn tableName=CREDENTIAL; addColumn tableName=FED_USER_CREDENTIAL',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-8.0.0.xml::8.0.0-updating-credential-data-not-oracle::keycloak
UPDATE CREDENTIAL
SET CREDENTIAL_DATA = CONCAT('{"hashIterations":', HASH_ITERATIONS, ',"algorithm":"', ALGORITHM, '"}'),
    PRIORITY        = '10',
    SECRET_DATA     = CONCAT('{"value":"', VALUE, '","salt":"__SALT__"}')
WHERE TYPE = 'password'
   OR TYPE = 'password-history'
GO

UPDATE CREDENTIAL
SET CREDENTIAL_DATA = CONCAT('{"subType":"totp","digits":', DIGITS, ',"period":', PERIOD, ',"algorithm":"', ALGORITHM,
                             '"}'),
    PRIORITY        = '20',
    SECRET_DATA     = CONCAT('{"value":"', VALUE, '"}'),
    TYPE            = 'otp'
WHERE TYPE = 'totp'
GO

UPDATE CREDENTIAL
SET CREDENTIAL_DATA = CONCAT('{"subType":"hotp","digits":', DIGITS, ',"counter":', COUNTER, ',"algorithm":"', ALGORITHM,
                             '"}'),
    PRIORITY        = '20',
    SECRET_DATA     = CONCAT('{"value":"', VALUE, '"}'),
    TYPE            = 'otp'
WHERE TYPE = 'hotp'
GO

UPDATE FED_USER_CREDENTIAL
SET CREDENTIAL_DATA = CONCAT('{"hashIterations":', HASH_ITERATIONS, ',"algorithm":"', ALGORITHM, '"}'),
    PRIORITY        = '10',
    SECRET_DATA     = CONCAT('{"value":"', VALUE, '","salt":"__SALT__"}')
WHERE TYPE = 'password'
   OR TYPE = 'password-history'
GO

UPDATE FED_USER_CREDENTIAL
SET CREDENTIAL_DATA = CONCAT('{"subType":"totp","digits":', DIGITS, ',"period":', PERIOD, ',"algorithm":"', ALGORITHM,
                             '"}'),
    PRIORITY        = '20',
    SECRET_DATA     = CONCAT('{"value":"', VALUE, '"}'),
    TYPE            = 'otp'
WHERE TYPE = 'totp'
GO

UPDATE FED_USER_CREDENTIAL
SET CREDENTIAL_DATA = CONCAT('{"subType":"hotp","digits":', DIGITS, ',"counter":', COUNTER, ',"algorithm":"', ALGORITHM,
                             '"}'),
    PRIORITY        = '20',
    SECRET_DATA     = CONCAT('{"value":"', VALUE, '"}'),
    TYPE            = 'otp'
WHERE TYPE = 'hotp'
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('8.0.0-updating-credential-data-not-oracle', 'keycloak', 'META-INF/jpa-changelog-8.0.0.xml', GETDATE(), 73,
        '8:aa47e66c23e04356194fe287169e9c35',
        'update tableName=CREDENTIAL; update tableName=CREDENTIAL; update tableName=CREDENTIAL; update tableName=FED_USER_CREDENTIAL; update tableName=FED_USER_CREDENTIAL; update tableName=FED_USER_CREDENTIAL',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-8.0.0.xml::8.0.0-updating-credential-data-oracle::keycloak
INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('8.0.0-updating-credential-data-oracle', 'keycloak', 'META-INF/jpa-changelog-8.0.0.xml', GETDATE(), 74,
        '8:aa8d0292cba5b0ca2749f792784db4ce',
        'update tableName=CREDENTIAL; update tableName=CREDENTIAL; update tableName=CREDENTIAL; update tableName=FED_USER_CREDENTIAL; update tableName=FED_USER_CREDENTIAL; update tableName=FED_USER_CREDENTIAL',
        '', 'MARK_RAN', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-8.0.0.xml::8.0.0-credential-cleanup-fixed::keycloak
DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CREDENTIAL')
  AND [c].[name] = N'COUNTER'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CREDENTIAL')
  AND [c].[name] = N'DIGITS'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CREDENTIAL')
  AND [c].[name] = N'PERIOD'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'CREDENTIAL')
  AND [c].[name] = N'ALGORITHM'
EXEC sp_executesql @sql
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN DEVICE
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN HASH_ITERATIONS
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN VALUE
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN COUNTER
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN DIGITS
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN PERIOD
GO

ALTER TABLE CREDENTIAL
    DROP COLUMN ALGORITHM
GO

DROP TABLE CREDENTIAL_ATTRIBUTE
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE FED_USER_CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'FED_USER_CREDENTIAL')
  AND [c].[name] = N'COUNTER'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE FED_USER_CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'FED_USER_CREDENTIAL')
  AND [c].[name] = N'DIGITS'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE FED_USER_CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'FED_USER_CREDENTIAL')
  AND [c].[name] = N'PERIOD'
EXEC sp_executesql @sql
GO

DECLARE @sql [nvarchar](MAX)
SELECT @sql = N'ALTER TABLE FED_USER_CREDENTIAL DROP CONSTRAINT ' + QUOTENAME([df].[name])
FROM [sys].[columns] AS [c]
         INNER JOIN [sys].[default_constraints] AS [df] ON [df].[object_id] = [c].[default_object_id]
WHERE [c].[object_id] = OBJECT_ID(N'FED_USER_CREDENTIAL')
  AND [c].[name] = N'ALGORITHM'
EXEC sp_executesql @sql
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN DEVICE
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN HASH_ITERATIONS
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN VALUE
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN COUNTER
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN DIGITS
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN PERIOD
GO

ALTER TABLE FED_USER_CREDENTIAL
    DROP COLUMN ALGORITHM
GO

DROP TABLE FED_CREDENTIAL_ATTRIBUTE
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('8.0.0-credential-cleanup-fixed', 'keycloak', 'META-INF/jpa-changelog-8.0.0.xml', GETDATE(), 75,
        '8:79e4fd6c6442980e58d52ffc3ee7b19c',
        'dropDefaultValue columnName=COUNTER, tableName=CREDENTIAL; dropDefaultValue columnName=DIGITS, tableName=CREDENTIAL; dropDefaultValue columnName=PERIOD, tableName=CREDENTIAL; dropDefaultValue columnName=ALGORITHM, tableName=CREDENTIAL; dropColumn ...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-8.0.0.xml::8.0.0-resource-tag-support::keycloak
ALTER TABLE MIGRATION_MODEL
    ADD UPDATE_TIME bigint
        CONSTRAINT DF_MIGRATION_MODEL_UPDATE_TIME DEFAULT 0 NOT NULL
GO

CREATE NONCLUSTERED INDEX IDX_UPDATE_TIME ON MIGRATION_MODEL (UPDATE_TIME)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('8.0.0-resource-tag-support', 'keycloak', 'META-INF/jpa-changelog-8.0.0.xml', GETDATE(), 76,
        '8:87af6a1e6d241ca4b15801d1f86a297d',
        'addColumn tableName=MIGRATION_MODEL; createIndex indexName=IDX_UPDATE_TIME, tableName=MIGRATION_MODEL', '',
        'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.0.xml::9.0.0-always-display-client::keycloak
ALTER TABLE CLIENT
    ADD ALWAYS_DISPLAY_IN_CONSOLE bit
        CONSTRAINT DF_CLIENT_ALWAYS_DISPLAY_IN_CONSOLE DEFAULT 0 NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.0-always-display-client', 'keycloak', 'META-INF/jpa-changelog-9.0.0.xml', GETDATE(), 77,
        '8:b44f8d9b7b6ea455305a6d72a200ed15', 'addColumn tableName=CLIENT', '', 'EXECUTED', NULL, NULL, '3.8.8',
        '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.0.xml::9.0.0-drop-constraints-for-column-increase::keycloak
ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    DROP CONSTRAINT UK_FRSR6T700S9V50BU18WS5PMT
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    DROP CONSTRAINT UK_FRSR6T700S9V50BU18WS5HA6
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    DROP CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK3
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.0-drop-constraints-for-column-increase', 'keycloak', 'META-INF/jpa-changelog-9.0.0.xml', GETDATE(), 78,
        '8:2d8ed5aaaeffd0cb004c046b4a903ac5',
        'dropUniqueConstraint constraintName=UK_FRSR6T700S9V50BU18WS5PMT, tableName=RESOURCE_SERVER_PERM_TICKET; dropUniqueConstraint constraintName=UK_FRSR6T700S9V50BU18WS5HA6, tableName=RESOURCE_SERVER_RESOURCE; dropPrimaryKey constraintName=CONSTRAINT_O...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.0.xml::9.0.0-increase-column-size-federated-fk::keycloak
ALTER TABLE FED_USER_CONSENT
    ALTER COLUMN CLIENT_ID varchar(255)
GO

ALTER TABLE KEYCLOAK_ROLE
    ALTER COLUMN CLIENT_REALM_CONSTRAINT varchar(255)
GO

ALTER TABLE RESOURCE_SERVER_POLICY
    ALTER COLUMN OWNER varchar(255)
GO

ALTER TABLE USER_CONSENT
    ALTER COLUMN CLIENT_ID varchar(255)
GO

ALTER TABLE USER_ENTITY
    ALTER COLUMN SERVICE_ACCOUNT_CLIENT_LINK varchar(255)
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ALTER COLUMN CLIENT_ID varchar(255)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ALTER COLUMN OWNER varchar(255)
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ALTER COLUMN REQUESTER varchar(255)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ALTER COLUMN OWNER varchar(255)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.0-increase-column-size-federated-fk', 'keycloak', 'META-INF/jpa-changelog-9.0.0.xml', GETDATE(), 79,
        '8:e290c01fcbc275326c511633f6e2acde',
        'modifyDataType columnName=CLIENT_ID, tableName=FED_USER_CONSENT; modifyDataType columnName=CLIENT_REALM_CONSTRAINT, tableName=KEYCLOAK_ROLE; modifyDataType columnName=OWNER, tableName=RESOURCE_SERVER_POLICY; modifyDataType columnName=CLIENT_ID, ta...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.0.xml::9.0.0-recreate-constraints-after-column-increase::keycloak
ALTER TABLE OFFLINE_CLIENT_SESSION
    ALTER COLUMN CLIENT_ID varchar(255) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ALTER COLUMN OWNER varchar(255) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ALTER COLUMN REQUESTER varchar(255) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ALTER COLUMN OWNER varchar(255) NOT NULL
GO

ALTER TABLE RESOURCE_SERVER_PERM_TICKET
    ADD CONSTRAINT UK_FRSR6T700S9V50BU18WS5PMT UNIQUE (OWNER, REQUESTER, RESOURCE_SERVER_ID, RESOURCE_ID, SCOPE_ID)
GO

ALTER TABLE RESOURCE_SERVER_RESOURCE
    ADD CONSTRAINT UK_FRSR6T700S9V50BU18WS5HA6 UNIQUE (NAME, OWNER, RESOURCE_SERVER_ID)
GO

ALTER TABLE OFFLINE_CLIENT_SESSION
    ADD CONSTRAINT CONSTRAINT_OFFL_CL_SES_PK3 PRIMARY KEY (USER_SESSION_ID, CLIENT_ID, CLIENT_STORAGE_PROVIDER,
                                                           EXTERNAL_CLIENT_ID, OFFLINE_FLAG)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.0-recreate-constraints-after-column-increase', 'keycloak', 'META-INF/jpa-changelog-9.0.0.xml', GETDATE(),
        80, '8:c9db8784c33cea210872ac2d805439f8',
        'addNotNullConstraint columnName=CLIENT_ID, tableName=OFFLINE_CLIENT_SESSION; addNotNullConstraint columnName=OWNER, tableName=RESOURCE_SERVER_PERM_TICKET; addNotNullConstraint columnName=REQUESTER, tableName=RESOURCE_SERVER_PERM_TICKET; addNotNull...',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.1.xml::9.0.1-add-index-to-client.client_id::keycloak
CREATE NONCLUSTERED INDEX IDX_CLIENT_ID ON CLIENT (CLIENT_ID)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.1-add-index-to-client.client_id', 'keycloak', 'META-INF/jpa-changelog-9.0.1.xml', GETDATE(), 81,
        '8:95b676ce8fc546a1fcfb4c92fae4add5', 'createIndex indexName=IDX_CLIENT_ID, tableName=CLIENT', '', 'EXECUTED',
        NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.1.xml::9.0.1-KEYCLOAK-12579-drop-constraints::keycloak
ALTER TABLE KEYCLOAK_GROUP
    DROP CONSTRAINT SIBLING_NAMES
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.1-KEYCLOAK-12579-drop-constraints', 'keycloak', 'META-INF/jpa-changelog-9.0.1.xml', GETDATE(), 82,
        '8:38a6b2a41f5651018b1aca93a41401e5',
        'dropUniqueConstraint constraintName=SIBLING_NAMES, tableName=KEYCLOAK_GROUP', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.1.xml::9.0.1-KEYCLOAK-12579-add-not-null-constraint::keycloak
UPDATE KEYCLOAK_GROUP
SET PARENT_GROUP = ' '
WHERE PARENT_GROUP IS NULL
GO

ALTER TABLE KEYCLOAK_GROUP
    ALTER COLUMN PARENT_GROUP varchar(36) NOT NULL
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.1-KEYCLOAK-12579-add-not-null-constraint', 'keycloak', 'META-INF/jpa-changelog-9.0.1.xml', GETDATE(), 83,
        '8:3fb99bcad86a0229783123ac52f7609c', 'addNotNullConstraint columnName=PARENT_GROUP, tableName=KEYCLOAK_GROUP',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.1.xml::9.0.1-KEYCLOAK-12579-recreate-constraints::keycloak
ALTER TABLE KEYCLOAK_GROUP
    ADD CONSTRAINT SIBLING_NAMES UNIQUE (REALM_ID, PARENT_GROUP, NAME)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.1-KEYCLOAK-12579-recreate-constraints', 'keycloak', 'META-INF/jpa-changelog-9.0.1.xml', GETDATE(), 84,
        '8:64f27a6fdcad57f6f9153210f2ec1bdb',
        'addUniqueConstraint constraintName=SIBLING_NAMES, tableName=KEYCLOAK_GROUP', '', 'EXECUTED', NULL, NULL,
        '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-9.0.1.xml::9.0.1-add-index-to-events::keycloak
CREATE NONCLUSTERED INDEX IDX_EVENT_TIME ON EVENT_ENTITY (REALM_ID, EVENT_TIME)
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('9.0.1-add-index-to-events', 'keycloak', 'META-INF/jpa-changelog-9.0.1.xml', GETDATE(), 85,
        '8:ab4f863f39adafd4c862f7ec01890abc', 'createIndex indexName=IDX_EVENT_TIME, tableName=EVENT_ENTITY', '',
        'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

-- Changeset META-INF/jpa-changelog-11.0.0.xml::map-remove-ri::keycloak
ALTER TABLE REALM
    DROP CONSTRAINT FK_TRAF444KK6QRKMS7N56AIWQ5Y
GO

ALTER TABLE KEYCLOAK_ROLE
    DROP CONSTRAINT FK_KJHO5LE2C0RAL09FL8CM9WFW9
GO

INSERT INTO DATABASECHANGELOG (ID, AUTHOR, FILENAME, DATEEXECUTED, ORDEREXECUTED, MD5SUM, DESCRIPTION, COMMENTS,
                               EXECTYPE, CONTEXTS, LABELS, LIQUIBASE, DEPLOYMENT_ID)
VALUES ('map-remove-ri', 'keycloak', 'META-INF/jpa-changelog-11.0.0.xml', GETDATE(), 86,
        '8:13c419a0eb336e91ee3a3bf8fda6e2a7',
        'dropForeignKeyConstraint baseTableName=REALM, constraintName=FK_TRAF444KK6QRKMS7N56AIWQ5Y; dropForeignKeyConstraint baseTableName=KEYCLOAK_ROLE, constraintName=FK_KJHO5LE2C0RAL09FL8CM9WFW9',
        '', 'EXECUTED', NULL, NULL, '3.8.8', '5410988868')
GO

